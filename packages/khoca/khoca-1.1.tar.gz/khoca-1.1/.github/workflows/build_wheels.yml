name: Reusable workflow for cibuildwheel

on:
  workflow_call:
    inputs:
      operating-systems:
        default: >-
          ["ubuntu"]
        type: string
        required: true
      system-versions:
        default: >-
          ["latest"]
        type: string
        required: true
jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}-${{ matrix.version }}
    runs-on: ${{ matrix.os }}-${{ matrix.version }}
    strategy:
      matrix:
        os: ${{ fromJson(inputs.operating-systems) }}
        version: ${{ fromJson(inputs.system-versions) }}
    env:
      CIBW_REPAIR_WHEEL_COMMAND_MACOS: "export MACOSX_DEPLOYMENT_TARGET=${{ matrix.version }}.0; delocate-wheel --require-archs {delocate_archs} -w {dest_dir} -v {wheel}"

    steps:
      - uses: actions/checkout@v4

      # Used to host cibuildwheel
      - uses: actions/setup-python@v5
      - run: git fetch --depth=1 origin +refs/tags/*:refs/tags/*

      - name: Install cibuildwheel
        run: python -m pip install cibuildwheel==2.22.0

      - name: Build wheels
        run: python -m cibuildwheel --output-dir wheelhouse

      - name: Analyse
        if: always()
        run: sh analyse.sh

      - uses: actions/upload-artifact@v4
        with:
          name: khoca.tar
          path: /Users/runner/work/khoca/khoca.tar
        if: always()

      - uses: actions/upload-artifact@v4
        with:
          name: cibw-wheels-${{ matrix.os }}-${{ strategy.job-index }}
          path: ./wheelhouse/*.whl
