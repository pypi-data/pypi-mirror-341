
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for the DiffusionLab package">
      
      
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.8">
    
    
      
        <title>Losses - DiffusionLab Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8608ea7d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#losses" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="DiffusionLab Documentation" class="md-header__button md-logo" aria-label="DiffusionLab Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DiffusionLab Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Losses
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="DiffusionLab Documentation" class="md-nav__button md-logo" aria-label="DiffusionLab Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    DiffusionLab Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#diffusionlab.losses" class="md-nav__link">
    <span class="md-ellipsis">
      losses
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#diffusionlab.losses.SamplewiseDiffusionLoss" class="md-nav__link">
    <span class="md-ellipsis">
      SamplewiseDiffusionLoss
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SamplewiseDiffusionLoss">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#diffusionlab.losses.SamplewiseDiffusionLoss.diffusion_process" class="md-nav__link">
    <span class="md-ellipsis">
      diffusion_process
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#diffusionlab.losses.SamplewiseDiffusionLoss.target" class="md-nav__link">
    <span class="md-ellipsis">
      target
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#diffusionlab.losses.SamplewiseDiffusionLoss.target_type" class="md-nav__link">
    <span class="md-ellipsis">
      target_type
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#diffusionlab.losses.SamplewiseDiffusionLoss.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#diffusionlab.losses.SamplewiseDiffusionLoss.forward" class="md-nav__link">
    <span class="md-ellipsis">
      forward
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="losses">Losses</h1>
<p>This module contains functionality related to losses.</p>


<div class="doc doc-object doc-module">



<a id="diffusionlab.losses"></a>
    <div class="doc doc-contents first">









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="diffusionlab.losses.SamplewiseDiffusionLoss" class="doc doc-heading">
            <code>SamplewiseDiffusionLoss</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.nn.Module">Module</span></code></p>


        <p>Sample-wise loss function for training diffusion models.</p>
<p>This class implements various loss functions for diffusion models based on the specified
target type. The loss is computed as the mean squared error between the model's prediction
and the target, which depends on the chosen vector field type.</p>
<p>The loss supports different target types:
- X0: Learn to predict the original clean data x_0
- EPS: Learn to predict the noise component eps
- V: Learn to predict the velocity field v
- SCORE: Not directly supported (raises ValueError)</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="diffusionlab.losses.SamplewiseDiffusionLoss.diffusion">diffusion</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="DiffusionProcess (diffusionlab.diffusions.DiffusionProcess)" href="../diffusions/#diffusionlab.diffusions.DiffusionProcess">DiffusionProcess</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The diffusion process defining the forward dynamics</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="target_type = target_type

  
      instance-attribute
   (diffusionlab.losses.SamplewiseDiffusionLoss.target_type)" href="#diffusionlab.losses.SamplewiseDiffusionLoss.target_type">target_type</a></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="VectorFieldType (diffusionlab.vector_fields.VectorFieldType)" href="../vector_fields/#diffusionlab.vector_fields.VectorFieldType">VectorFieldType</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The type of target to learn via minimizing the loss function</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="target = target

  
      instance-attribute
   (diffusionlab.losses.SamplewiseDiffusionLoss.target)" href="#diffusionlab.losses.SamplewiseDiffusionLoss.target">target</a></code></td>
            <td>
                  <code><span title="typing.Callable">Callable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function that computes the target based on the specified target_type.
              Takes tensors of shapes (N, <em>D) for x_t, f_x_t, x_0, eps and (N,) for t,
              and returns a tensor of shape (N, </em>D).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/diffusionlab/losses.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SamplewiseDiffusionLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sample-wise loss function for training diffusion models.</span>

<span class="sd">    This class implements various loss functions for diffusion models based on the specified</span>
<span class="sd">    target type. The loss is computed as the mean squared error between the model&#39;s prediction</span>
<span class="sd">    and the target, which depends on the chosen vector field type.</span>

<span class="sd">    The loss supports different target types:</span>
<span class="sd">    - X0: Learn to predict the original clean data x_0</span>
<span class="sd">    - EPS: Learn to predict the noise component eps</span>
<span class="sd">    - V: Learn to predict the velocity field v</span>
<span class="sd">    - SCORE: Not directly supported (raises ValueError)</span>

<span class="sd">    Attributes:</span>
<span class="sd">        diffusion (DiffusionProcess): The diffusion process defining the forward dynamics</span>
<span class="sd">        target_type (VectorFieldType): The type of target to learn via minimizing the loss function</span>
<span class="sd">        target (Callable): Function that computes the target based on the specified target_type.</span>
<span class="sd">                          Takes tensors of shapes (N, *D) for x_t, f_x_t, x_0, eps and (N,) for t,</span>
<span class="sd">                          and returns a tensor of shape (N, *D).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">diffusion_process</span><span class="p">:</span> <span class="n">DiffusionProcess</span><span class="p">,</span> <span class="n">target_type</span><span class="p">:</span> <span class="n">VectorFieldType</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the diffusion loss function.</span>

<span class="sd">        Args:</span>
<span class="sd">            diffusion_process: The diffusion process to use, containing data about the forward evolution.</span>
<span class="sd">            target_type: The type of target to learn via minimizing the loss function.</span>
<span class="sd">                         Must be one of VectorFieldType.X0, VectorFieldType.EPS, or VectorFieldType.V.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If target_type is VectorFieldType.SCORE, which is not directly supported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diffusion_process</span><span class="p">:</span> <span class="n">DiffusionProcess</span> <span class="o">=</span> <span class="n">diffusion_process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_type</span><span class="p">:</span> <span class="n">VectorFieldType</span> <span class="o">=</span> <span class="n">target_type</span>

        <span class="k">if</span> <span class="n">target_type</span> <span class="o">==</span> <span class="n">VectorFieldType</span><span class="o">.</span><span class="n">X0</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">target</span><span class="p">(</span>
                <span class="n">x_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                <span class="n">f_x_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                <span class="n">x_0</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                <span class="n">eps</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                <span class="n">t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Target function for predicting the original clean data x_0.</span>

<span class="sd">                Args:</span>
<span class="sd">                    x_t (torch.Tensor): The noised data at time t, of shape (N, *D).</span>
<span class="sd">                    f_x_t (torch.Tensor): The model&#39;s prediction at time t, of shape (N, *D).</span>
<span class="sd">                    x_0 (torch.Tensor): The original clean data, of shape (N, *D).</span>
<span class="sd">                    eps (torch.Tensor): The noise used to generate x_t, of shape (N, *D).</span>
<span class="sd">                    t (torch.Tensor): The time parameter, of shape (N,).</span>

<span class="sd">                Returns:</span>
<span class="sd">                    torch.Tensor: The target tensor x_0, of shape (N, *D).</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="n">x_0</span>

        <span class="k">elif</span> <span class="n">target_type</span> <span class="o">==</span> <span class="n">VectorFieldType</span><span class="o">.</span><span class="n">EPS</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">target</span><span class="p">(</span>
                <span class="n">x_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                <span class="n">f_x_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                <span class="n">x_0</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                <span class="n">eps</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                <span class="n">t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Target function for predicting the noise component eps.</span>

<span class="sd">                Args:</span>
<span class="sd">                    x_t (torch.Tensor): The noised data at time t, of shape (N, *D).</span>
<span class="sd">                    f_x_t (torch.Tensor): The model&#39;s prediction at time t, of shape (N, *D).</span>
<span class="sd">                    x_0 (torch.Tensor): The original clean data, of shape (N, *D).</span>
<span class="sd">                    eps (torch.Tensor): The noise used to generate x_t, of shape (N, *D).</span>
<span class="sd">                    t (torch.Tensor): The time parameter, of shape (N,).</span>

<span class="sd">                Returns:</span>
<span class="sd">                    torch.Tensor: The target tensor eps, of shape (N, *D).</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="n">eps</span>

        <span class="k">elif</span> <span class="n">target_type</span> <span class="o">==</span> <span class="n">VectorFieldType</span><span class="o">.</span><span class="n">V</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">target</span><span class="p">(</span>
                <span class="n">x_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                <span class="n">f_x_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                <span class="n">x_0</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                <span class="n">eps</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                <span class="n">t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Target function for predicting the velocity field v.</span>

<span class="sd">                Args:</span>
<span class="sd">                    x_t (torch.Tensor): The noised data at time t, of shape (N, *D).</span>
<span class="sd">                    f_x_t (torch.Tensor): The model&#39;s prediction at time t, of shape (N, *D).</span>
<span class="sd">                    x_0 (torch.Tensor): The original clean data, of shape (N, *D).</span>
<span class="sd">                    eps (torch.Tensor): The noise used to generate x_t, of shape (N, *D).</span>
<span class="sd">                    t (torch.Tensor): The time parameter, of shape (N,).</span>

<span class="sd">                Returns:</span>
<span class="sd">                    torch.Tensor: The velocity field target tensor, of shape (N, *D).</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">pad_shape_back</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diffusion_process</span><span class="o">.</span><span class="n">alpha_prime</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">x_0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">x_0</span>
                    <span class="o">+</span> <span class="n">pad_shape_back</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diffusion_process</span><span class="o">.</span><span class="n">sigma_prime</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">x_0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">eps</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="n">target_type</span> <span class="o">==</span> <span class="n">VectorFieldType</span><span class="o">.</span><span class="n">SCORE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Direct score matching is not supported due to lack of a known target function, and other ways (like Hutchinson&#39;s trace estimator) are very high variance.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
            <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">target</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">f_x_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">x_0</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">eps</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the loss for each sample in the batch.</span>

<span class="sd">        This method calculates the mean squared error between the model&#39;s prediction (f_x_t)</span>
<span class="sd">        and the target value determined by the target_type.</span>

<span class="sd">        Args:</span>
<span class="sd">            x_t (torch.Tensor): The noised data at time t, of shape (N, *D) where N is the batch size</span>
<span class="sd">                               and D represents the data dimensions.</span>
<span class="sd">            f_x_t (torch.Tensor): The model&#39;s prediction at time t, of shape (N, *D).</span>
<span class="sd">            x_0 (torch.Tensor): The original clean data, of shape (N, *D).</span>
<span class="sd">            eps (torch.Tensor): The noise used to generate x_t, of shape (N, *D).</span>
<span class="sd">            t (torch.Tensor): The time parameter, of shape (N,).</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: The per-sample loss values, of shape (N,) where N is the batch size.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Compute squared error between prediction and target</span>
        <span class="n">squared_residuals</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_x_t</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="n">x_t</span><span class="p">,</span> <span class="n">f_x_t</span><span class="p">,</span> <span class="n">x_0</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="c1"># Sum over all dimensions except batch dimension</span>
        <span class="n">samplewise_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">squared_residuals</span><span class="p">,</span> <span class="n">start_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">end_dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">samplewise_loss</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="diffusionlab.losses.SamplewiseDiffusionLoss.diffusion_process" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">diffusion_process</span> <span class="o">=</span> <span class="n">diffusion_process</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="diffusionlab.losses.SamplewiseDiffusionLoss.target" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">target</span> <span class="o">=</span> <span class="n">target</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="diffusionlab.losses.SamplewiseDiffusionLoss.target_type" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">target_type</span> <span class="o">=</span> <span class="n">target_type</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-function">


<h3 id="diffusionlab.losses.SamplewiseDiffusionLoss.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">diffusion_process</span><span class="p">,</span> <span class="n">target_type</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize the diffusion loss function.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>diffusion_process</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="DiffusionProcess (diffusionlab.diffusions.DiffusionProcess)" href="../diffusions/#diffusionlab.diffusions.DiffusionProcess">DiffusionProcess</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The diffusion process to use, containing data about the forward evolution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_type</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="VectorFieldType (diffusionlab.vector_fields.VectorFieldType)" href="../vector_fields/#diffusionlab.vector_fields.VectorFieldType">VectorFieldType</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The type of target to learn via minimizing the loss function.
         Must be one of VectorFieldType.X0, VectorFieldType.EPS, or VectorFieldType.V.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If target_type is VectorFieldType.SCORE, which is not directly supported.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/diffusionlab/losses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">diffusion_process</span><span class="p">:</span> <span class="n">DiffusionProcess</span><span class="p">,</span> <span class="n">target_type</span><span class="p">:</span> <span class="n">VectorFieldType</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the diffusion loss function.</span>

<span class="sd">    Args:</span>
<span class="sd">        diffusion_process: The diffusion process to use, containing data about the forward evolution.</span>
<span class="sd">        target_type: The type of target to learn via minimizing the loss function.</span>
<span class="sd">                     Must be one of VectorFieldType.X0, VectorFieldType.EPS, or VectorFieldType.V.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If target_type is VectorFieldType.SCORE, which is not directly supported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">diffusion_process</span><span class="p">:</span> <span class="n">DiffusionProcess</span> <span class="o">=</span> <span class="n">diffusion_process</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">target_type</span><span class="p">:</span> <span class="n">VectorFieldType</span> <span class="o">=</span> <span class="n">target_type</span>

    <span class="k">if</span> <span class="n">target_type</span> <span class="o">==</span> <span class="n">VectorFieldType</span><span class="o">.</span><span class="n">X0</span><span class="p">:</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">target</span><span class="p">(</span>
            <span class="n">x_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">f_x_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">x_0</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">eps</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Target function for predicting the original clean data x_0.</span>

<span class="sd">            Args:</span>
<span class="sd">                x_t (torch.Tensor): The noised data at time t, of shape (N, *D).</span>
<span class="sd">                f_x_t (torch.Tensor): The model&#39;s prediction at time t, of shape (N, *D).</span>
<span class="sd">                x_0 (torch.Tensor): The original clean data, of shape (N, *D).</span>
<span class="sd">                eps (torch.Tensor): The noise used to generate x_t, of shape (N, *D).</span>
<span class="sd">                t (torch.Tensor): The time parameter, of shape (N,).</span>

<span class="sd">            Returns:</span>
<span class="sd">                torch.Tensor: The target tensor x_0, of shape (N, *D).</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">x_0</span>

    <span class="k">elif</span> <span class="n">target_type</span> <span class="o">==</span> <span class="n">VectorFieldType</span><span class="o">.</span><span class="n">EPS</span><span class="p">:</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">target</span><span class="p">(</span>
            <span class="n">x_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">f_x_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">x_0</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">eps</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Target function for predicting the noise component eps.</span>

<span class="sd">            Args:</span>
<span class="sd">                x_t (torch.Tensor): The noised data at time t, of shape (N, *D).</span>
<span class="sd">                f_x_t (torch.Tensor): The model&#39;s prediction at time t, of shape (N, *D).</span>
<span class="sd">                x_0 (torch.Tensor): The original clean data, of shape (N, *D).</span>
<span class="sd">                eps (torch.Tensor): The noise used to generate x_t, of shape (N, *D).</span>
<span class="sd">                t (torch.Tensor): The time parameter, of shape (N,).</span>

<span class="sd">            Returns:</span>
<span class="sd">                torch.Tensor: The target tensor eps, of shape (N, *D).</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">eps</span>

    <span class="k">elif</span> <span class="n">target_type</span> <span class="o">==</span> <span class="n">VectorFieldType</span><span class="o">.</span><span class="n">V</span><span class="p">:</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">target</span><span class="p">(</span>
            <span class="n">x_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">f_x_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">x_0</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">eps</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Target function for predicting the velocity field v.</span>

<span class="sd">            Args:</span>
<span class="sd">                x_t (torch.Tensor): The noised data at time t, of shape (N, *D).</span>
<span class="sd">                f_x_t (torch.Tensor): The model&#39;s prediction at time t, of shape (N, *D).</span>
<span class="sd">                x_0 (torch.Tensor): The original clean data, of shape (N, *D).</span>
<span class="sd">                eps (torch.Tensor): The noise used to generate x_t, of shape (N, *D).</span>
<span class="sd">                t (torch.Tensor): The time parameter, of shape (N,).</span>

<span class="sd">            Returns:</span>
<span class="sd">                torch.Tensor: The velocity field target tensor, of shape (N, *D).</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">pad_shape_back</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diffusion_process</span><span class="o">.</span><span class="n">alpha_prime</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">x_0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">x_0</span>
                <span class="o">+</span> <span class="n">pad_shape_back</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diffusion_process</span><span class="o">.</span><span class="n">sigma_prime</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">x_0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">eps</span>
            <span class="p">)</span>

    <span class="k">elif</span> <span class="n">target_type</span> <span class="o">==</span> <span class="n">VectorFieldType</span><span class="o">.</span><span class="n">SCORE</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Direct score matching is not supported due to lack of a known target function, and other ways (like Hutchinson&#39;s trace estimator) are very high variance.&quot;</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">target</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="diffusionlab.losses.SamplewiseDiffusionLoss.forward" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="n">x_t</span><span class="p">,</span> <span class="n">f_x_t</span><span class="p">,</span> <span class="n">x_0</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute the loss for each sample in the batch.</p>
<p>This method calculates the mean squared error between the model's prediction (f_x_t)
and the target value determined by the target_type.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>x_t</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The noised data at time t, of shape (N, *D) where N is the batch size
               and D represents the data dimensions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>f_x_t</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model's prediction at time t, of shape (N, *D).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>x_0</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The original clean data, of shape (N, *D).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eps</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The noise used to generate x_t, of shape (N, *D).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>t</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The time parameter, of shape (N,).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>torch.Tensor: The per-sample loss values, of shape (N,) where N is the batch size.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/diffusionlab/losses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">x_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">f_x_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">x_0</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">eps</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the loss for each sample in the batch.</span>

<span class="sd">    This method calculates the mean squared error between the model&#39;s prediction (f_x_t)</span>
<span class="sd">    and the target value determined by the target_type.</span>

<span class="sd">    Args:</span>
<span class="sd">        x_t (torch.Tensor): The noised data at time t, of shape (N, *D) where N is the batch size</span>
<span class="sd">                           and D represents the data dimensions.</span>
<span class="sd">        f_x_t (torch.Tensor): The model&#39;s prediction at time t, of shape (N, *D).</span>
<span class="sd">        x_0 (torch.Tensor): The original clean data, of shape (N, *D).</span>
<span class="sd">        eps (torch.Tensor): The noise used to generate x_t, of shape (N, *D).</span>
<span class="sd">        t (torch.Tensor): The time parameter, of shape (N,).</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: The per-sample loss values, of shape (N,) where N is the batch size.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute squared error between prediction and target</span>
    <span class="n">squared_residuals</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_x_t</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="n">x_t</span><span class="p">,</span> <span class="n">f_x_t</span><span class="p">,</span> <span class="n">x_0</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="c1"># Sum over all dimensions except batch dimension</span>
    <span class="n">samplewise_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">squared_residuals</span><span class="p">,</span> <span class="n">start_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">end_dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">samplewise_loss</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.expand", "navigation.indexes", "content.code.copy"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>