"use strict";(self.webpackChunkhome_assistant_frontend=self.webpackChunkhome_assistant_frontend||[]).push([["78786"],{32672:function(e,t,r){r.a(e,(async function(e,a){try{r.r(t),r.d(t,{HuiEnergyUsageGraphCard:()=>C});var o=r(73577),s=(r(19083),r(71695),r(92745),r(61893),r(19423),r(40251),r(92519),r(42179),r(89256),r(24931),r(88463),r(57449),r(19814),r(39527),r(41360),r(36993),r(47021),r(42625)),i=r(83389),n=r(16444),d=r(57243),c=r(50778),l=r(35359),h=r(27486),u=r(20548),_=r(50602),f=r(25179),g=(r(54977),r(1118)),y=r(17705),m=r(6736),p=r(93331),v=r(53259),b=e([f,g,_,v]);[f,g,_,v]=b.then?(await b)():b;let k,S,O,j,E=e=>e;const x={to_grid:"--energy-grid-return-color",to_battery:"--energy-battery-in-color",from_grid:"--energy-grid-consumption-color",used_grid:"--energy-grid-consumption-color",used_solar:"--energy-solar-color",used_battery:"--energy-battery-out-color"};let C=(0,o.Z)([(0,c.Mo)("hui-energy-usage-graph-card")],(function(e,t){return{F:class extends t{constructor(...t){super(...t),e(this)}},d:[{kind:"field",decorators:[(0,c.Cb)({attribute:!1})],key:"hass",value:void 0},{kind:"field",decorators:[(0,c.SB)()],key:"_config",value:void 0},{kind:"field",decorators:[(0,c.SB)()],key:"_chartData",value(){return[]}},{kind:"field",decorators:[(0,c.SB)()],key:"_start",value(){return(0,s.I)()}},{kind:"field",decorators:[(0,c.SB)()],key:"_end",value(){return(0,i.p)()}},{kind:"field",decorators:[(0,c.SB)()],key:"_compareStart",value:void 0},{kind:"field",decorators:[(0,c.SB)()],key:"_compareEnd",value:void 0},{kind:"field",key:"hassSubscribeRequiredHostProps",value(){return["_config"]}},{kind:"method",key:"hassSubscribe",value:function(){var e;return[(0,g.UB)(this.hass,{key:null===(e=this._config)||void 0===e?void 0:e.collection_key}).subscribe((e=>this._getStatistics(e)))]}},{kind:"method",key:"getCardSize",value:function(){return 3}},{kind:"method",key:"setConfig",value:function(e){this._config=e}},{kind:"method",key:"shouldUpdate",value:function(e){return(0,p.SN)(this,e)||e.size>1||!e.has("hass")}},{kind:"method",key:"render",value:function(){return this.hass&&this._config?(0,d.dy)(k||(k=E` <ha-card> ${0} <div class="content ${0}"> <ha-chart-base .hass="${0}" .data="${0}" .options="${0}" chart-type="bar"></ha-chart-base> ${0} </div> </ha-card> `),this._config.title?(0,d.dy)(S||(S=E`<h1 class="card-header">${0}</h1>`),this._config.title):"",(0,l.$)({"has-header":!!this._config.title}),this.hass,this._chartData,this._createOptions(this._start,this._end,this.hass.locale,this.hass.config,this._compareStart,this._compareEnd),this._chartData.some((e=>e.data.length))?"":(0,d.dy)(O||(O=E`<div class="no-data"> ${0} </div>`),(0,n.z)(this._start)?this.hass.localize("ui.panel.lovelace.cards.energy.no_data"):this.hass.localize("ui.panel.lovelace.cards.energy.no_data_period"))):d.Ld}},{kind:"field",key:"_formatTotal",value(){return e=>e>0?this.hass.localize("ui.panel.lovelace.cards.energy.energy_usage_graph.total_consumed",{num:(0,_.uf)(e,this.hass.locale)}):this.hass.localize("ui.panel.lovelace.cards.energy.energy_usage_graph.total_returned",{num:(0,_.uf)(-e,this.hass.locale)})}},{kind:"field",key:"_createOptions",value(){return(0,h.Z)(((e,t,r,a,o,s)=>{const i=(0,v.J)(e,t,r,a,"kWh",o,s,this._formatTotal);return Object.assign(Object.assign({},i),{},{tooltip:Object.assign(Object.assign({},i.tooltip),{},{formatter:e=>{var t,r;return Array.isArray(e)?(e.sort(((e,t)=>{var r,a;const o=null===(r=e.value)||void 0===r?void 0:r[1],s=null===(a=t.value)||void 0===a?void 0:a[1];return o>0&&s<0?-1:s>0&&o<0?1:o>0?t.componentIndex-e.componentIndex:e.componentIndex-t.componentIndex})),null===(t=i.tooltip)||void 0===t||null===(r=t.formatter)||void 0===r?void 0:r.call(t,e)):""}})})}))}},{kind:"method",key:"_getStatistics",value:async function(e){const t=[],r={};for(const i of e.prefs.energy_sources)if("solar"!==i.type)if("battery"!==i.type){if("grid"===i.type){for(const e of i.flow_from)r.from_grid?r.from_grid.push(e.stat_energy_from):r.from_grid=[e.stat_energy_from];for(const e of i.flow_to)r.to_grid?r.to_grid.push(e.stat_energy_to):r.to_grid=[e.stat_energy_to]}}else r.to_battery?(r.to_battery.push(i.stat_energy_to),r.from_battery.push(i.stat_energy_from)):(r.to_battery=[i.stat_energy_to],r.from_battery=[i.stat_energy_from]);else r.solar?r.solar.push(i.stat_energy_from):r.solar=[i.stat_energy_from];const a=getComputedStyle(this),o={};Object.keys(x).forEach((e=>{o[e]={},"used_grid"!==e&&"used_solar"!==e&&"used_battery"!==e&&r[e]&&Object.values(r[e]).forEach(((t,r)=>{o[e][t]=r}))}));const s={used_grid:this.hass.localize("ui.panel.lovelace.cards.energy.energy_usage_graph.combined_from_grid"),used_solar:this.hass.localize("ui.panel.lovelace.cards.energy.energy_usage_graph.consumed_solar"),used_battery:this.hass.localize("ui.panel.lovelace.cards.energy.energy_usage_graph.consumed_battery")};if(this._start=e.start,this._end=e.end||(0,i.p)(),this._compareStart=e.startCompare,this._compareEnd=e.endCompare,e.statsCompare)t.push(...this._processDataSet(e.statsCompare,e.statsMetadata,r,o,a,s,!0));else{var n,d;const e=null!==(n=null===(d=r.from_grid)||void 0===d?void 0:d[0])&&void 0!==n?n:"placeholder";t.push({id:"compare-"+e,type:"bar",stack:"usage",data:[]})}t.push(...this._processDataSet(e.stats,e.statsMetadata,r,o,a,s,!1)),(0,v.Zx)(t),this._chartData=t}},{kind:"method",key:"_processDataSet",value:function(e,t,r,a,o,s,i=!1){const n=[],d={},c={};Object.entries(r).forEach((([t,r])=>{const a=["solar","to_grid","from_grid","to_battery","from_battery"].includes(t),o=!["solar","from_battery"].includes(t),s={},i={};r.forEach((t=>{const r=e[t];if(!r)return;const n={};r.forEach((e=>{if(null===e.change||void 0===e.change)return;const t=e.change;a&&(s[e.start]=e.start in s?s[e.start]+t:t),o&&!(e.start in n)&&(n[e.start]=t)})),i[t]=n})),a&&(c[t]=s),o&&(d[t]=i)}));const l={},h={};if((c.to_grid||c.to_battery)&&c.solar){const e={};for(const t of Object.keys(c.solar)){var _,f;if(e[t]=(c.solar[t]||0)-((null===(_=c.to_grid)||void 0===_?void 0:_[t])||0)-((null===(f=c.to_battery)||void 0===f?void 0:f[t])||0),e[t]<0){var g,m,p;if(c.to_battery)if(l[t]=-1*e[t],l[t]>((null===(g=c.from_grid)||void 0===g?void 0:g[t])||0))h[t]=l[t]-((null===(m=c.from_grid)||void 0===m?void 0:m[t])||0),l[t]=null===(p=c.from_grid)||void 0===p?void 0:p[t];e[t]=0}}d.used_solar={used_solar:e}}if(c.from_battery)if(c.to_grid){const e={};for(const t of Object.keys(c.from_battery))e[t]=(c.from_battery[t]||0)-(h[t]||0);d.used_battery={used_battery:e}}else d.used_battery={used_battery:c.from_battery};if(d.from_grid&&c.to_battery){const e={};for(const t of Object.keys(l)){let r,a=0;for(const[e,o]of Object.entries(d.from_grid))if(o[t]&&(r=e,a++),a>1)break;if(1===a)d.from_grid[r][t]-=l[t]||0;else{let r=0;Object.values(d.from_grid).forEach((e=>{r+=e[t]||0,delete e[t]})),e[t]=r-(l[t]||0)}}d.used_grid={used_grid:e}}let v=[];Object.values(d).forEach((e=>{Object.values(e).forEach((e=>{v=v.concat(Object.keys(e))}))}));const b=Array.from(new Set(v)).sort(((e,t)=>Number(e)-Number(t))),k=i?this._start.getTime()-this._compareStart.getTime():0;return Object.entries(d).forEach((([e,r])=>{Object.entries(r).forEach((([r,d])=>{var c,l;const h=[];for(const t of b){const r=d[t]||0,a=[Number(t),r&&["to_grid","to_battery"].includes(e)?-1*r:r];i&&(a[2]=a[0],a[0]+=k),h.push(a)}n.push({id:i?"compare-"+r:r,type:"bar",name:e in s?s[e]:(0,y.Kd)(this.hass,r,t[r]),barMaxWidth:50,itemStyle:{borderColor:(0,u.H)(o,this.hass.themes.darkMode,!1,i,x[e],null===(c=a[e])||void 0===c?void 0:c[r])},color:(0,u.H)(o,this.hass.themes.darkMode,!0,i,x[e],null===(l=a[e])||void 0===l?void 0:l[r]),stack:i?"compare":"usage",data:h})}))})),n}},{kind:"field",static:!0,key:"styles",value(){return(0,d.iv)(j||(j=E`ha-card{height:100%}.card-header{padding-bottom:0}.content{padding:16px}.has-header{padding-top:0}.no-data{position:absolute;height:100%;top:0;left:0;right:0;display:flex;justify-content:center;align-items:center;padding:20%;margin-left:32px;margin-inline-start:32px;margin-inline-end:initial;box-sizing:border-box}`))}}]}}),(0,m.f)(d.oi));a()}catch(k){a(k)}}))}}]);
//# sourceMappingURL=78786.3eb9590e4ddbe9ce.js.map