include:
  - project: 'cta-computing/dpps/aiv/dpps-aiv-toolkit'
    ref: d8cff5a980e774cb0da7e0c260fb47a848909eb1
    file: "ci-functions.yml"
  - "aiv-config.yml"

stages:
  - prepare
  - lint
  - build
  - sign
  - tests
  - sonarqube
  - publish
  - report

#  full test for report, including summary and coverage xml artifacts
test:
  stage: tests
  image: harbor.cta-observatory.org/proxy_cache/python:3.12

  before_script:
    - python --version
    - pip install -e .[test]
    - apt update --yes && apt install --yes nodejs

  script:
    - >-
      pytest -v --color=yes
      --doctest-modules --doctest-glob='docs/**/*.rst'
      --ignore-glob='src/datapipe/_dev_version/*'
      --cov --cov-report=xml:coverage.xml
      --junitxml=report.xml
      --log-cli-level=INFO

  after_script: []

  artifacts:
    paths:
      - coverage.xml
      - report.xml


# unit tests using a matrix of python versions
unittests:
  stage: tests
  parallel:
    matrix:
      - PYTHON_VERSION:
        - "3.11"
        - "3.12"
        - "3.13"

  image: "harbor.cta-observatory.org/proxy_cache/python:$PYTHON_VERSION"

  before_script:
    - apt update --yes
    - apt install --yes nodejs # needed for cwl with JS
    - python --version
    - pip install -e .[test]

  script:
    - >-
      pytest -v --color=yes
      --doctest-modules
      --doctest-glob='docs/**/*.rst' --ignore-glob='src/datapipe/_dev_version/*'


publish-chart:
  rules:
    - when: never
