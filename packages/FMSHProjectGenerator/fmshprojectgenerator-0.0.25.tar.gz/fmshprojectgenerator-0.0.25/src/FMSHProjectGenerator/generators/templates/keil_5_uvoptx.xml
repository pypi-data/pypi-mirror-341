{# DEBUG TOOLS ------------------------------------------------------------------------------------------------------ #}
{# dummy contents of <DebugOpt> tag #}
{% set dbg_opt_dummy_before -%}
				<uSim>0</uSim>
				<uTrg>1</uTrg>
				<sLdApp>1</sLdApp>
				<sGomain>1</sGomain>
				<sRbreak>1</sRbreak>
				<sRwatch>1</sRwatch>
				<sRmem>1</sRmem>
				<sRfunc>1</sRfunc>
				<sRbox>1</sRbox>
				<tLdApp>1</tLdApp>
				<tGomain>1</tGomain>
				<tRbreak>1</tRbreak>
				<tRwatch>1</tRwatch>
				<tRmem>1</tRmem>
				<tRfunc>1</tRfunc>
				<tRbox>1</tRbox>
				<sRunDeb>0</sRunDeb>
				<sLrtime>0</sLrtime>
{%- endset %}
{% set dbg_opt_dummy_after -%}
				<sDll />
				<sDllPa />
				<sDlgDll />
				<sDlgPa />
				<sIfile />
				<tDll />
				<tDllPa />
				<tDlgDll />
				<tDlgPa />
				<tIfile />
{%- endset %}
{# JLink ----------------------------------------------- #}
{# JLink selection inside <DebugOpt> tag #}
{% set jlink_dbg_opt -%}
				{{ dbg_opt_dummy_before }}
				<nTsel>4</nTsel>
				{{ dbg_opt_dummy_after }}
				<pMon>Segger\JL2CM3.dll</pMon>
{%- endset %}
{# JLink dll info inside <TargetDriverDllRegistry> tag #}
{% macro jlink_dll(target, interface, speed, connect, reset, dl) -%}
				{%- set interface_mask = {
						'JTAG': 0,
						'SWD': 64,
					}
				-%}
				{%- set connect_mask = {
						'normal': 0,
						'with pre-reset': 1024,
						'under reset': 2048,
					}
				-%}
				{%- set reset_val = {
						'normal': 0,
						'core': 1,
						'reset pin': 2,
					}
				-%}
				{%- set dl_erase_val = {
						'full-chip': 17,
						'sectors': 1,
					    'none': 0,
					}
				-%}
				{% set dl_opt_num = dl_erase_val[dl['erase']] %}
				{% set dl_opt_num = dl_opt_num + 2 if dl['program'] else dl_opt_num %}
				{% set dl_opt_num = dl_opt_num + 4 if dl['verify'] else dl_opt_num %}
				{% set dl_opt_num = dl_opt_num + 8 if dl['reset-run'] else dl_opt_num -%}
				<SetRegEntry>
					<Number>0</Number>
					<Key>JL2CM3</Key>
					<Name>
						-U -O{{ interface_mask[interface] + connect_mask[connect] + 6 }} -S4 -ZTIFSpeedSel{{ speed }} -A0 -C0 -JU1 -JI127.0.0.1 -JP0 -RST{{ reset_val[reset] }} -TO18 -TC10000000 -TP21 -TDS8001 -TDT0 -TDC1F -TIEFFFFFFFF -TIP8 -TB1 -TFE0
						-FO{{ dl_opt_num }}
						-FD{{ target.keil_5_flash_algorithms_ram.base }} -FC{{ target.keil_5_flash_algorithms_ram.size }}
						-FN1{% for item in target.keil_5_flash_algorithms -%}
						-FF{{ loop.index0 }}{{ item.name }} -FS{{ loop.index0 }}{{ item.base }} -FL{{ loop.index0 }}{{ item.size }}
						{%- if item.path != none %} -FP{{ loop.index0 }}($$Device:{{ target.name }}${{ item.path }}){% endif %}
						{% endfor -%}
{{ '\n' }}					</Name>
				</SetRegEntry>
{%- endmacro %}
{# JLink debug description inside <DebugDescription> tag #}
{% macro jlink_debug_desc(speed) -%}
{# USELESS #}
{%- endmacro %}
{# CMSIS_DAP ----------------------------------------------- #}
{# CMSIS_DAP selection inside <DebugOpt> tag #}
{% set cmsis_dap_dbg_opt -%}
				{{ dbg_opt_dummy_before }}
				<nTsel>3</nTsel>
				{{ dbg_opt_dummy_after }}
				<pMon>BIN\CMSIS_AGDI.dll</pMon>
{%- endset %}
{# CMSIS_DAP dll info inside <TargetDriverDllRegistry> tag #}
{% macro cmsis_dap_dll(target, interface, speed, connect, reset, dl) -%}
				{%- set interface_mask = {
						'JTAG': 0,
						'SWD': 64,
					}
				-%}
				{%- set connect_mask = {
						'normal': 0,
						'with pre-reset': 1024,
						'under reset': 2048,
					}
				-%}
				{%- set reset_mask = {
						'normal': 256,
						'core': 512,
						'reset pin': 0,
					}
				-%}
				{%- set speed_val = {
						10000: 8,
						5000: 9,
						2000: 10,
					    1000: 0,
					    500: 1,
					    200: 2,
					    100: 3,
						50: 4,
						20: 5,
					 	10: 6,
					    5: 7,
					}
				-%}
				{%- if speed in speed_val -%}
					{%- set speed_num = speed_val[speed] -%}
				{%- else -%}
					{%- set speed_num = 8 -%}
				{%- endif %}
				{%- set dl_erase_val = {
						'full chip': 17,
						'sectors': 1,
					    'none': 0,
					}
				-%}
				{% set dl_opt_num = dl_erase_val[dl['erase']] %}
				{% set dl_opt_num = dl_opt_num + 2 if dl['program'] else dl_opt_num %}
				{% set dl_opt_num = dl_opt_num + 4 if dl['verify'] else dl_opt_num %}
				{% set dl_opt_num = dl_opt_num + 8 if dl['reset-run'] else dl_opt_num -%}
				<SetRegEntry>
					<Number>0</Number>
					<Key>CMSIS_AGDI</Key>
					<Name>
						-X"" -O{{ interface_mask[interface] + connect_mask[connect] + reset_mask[reset] + 398 }} -S{{ speed_num }} -C0 -P00000000 -N00("") -D00(00000000) -L00(0) -TO65554 -TC10000000 -TT10000000 -TP20 -TDS8007 -TDT0 -TDC1F -TIEFFFFFFFF -TIP8
						-FO{{ dl_opt_num }}
						-FD{{ target.keil_5_flash_algorithms_ram.base }} -FC{{ target.keil_5_flash_algorithms_ram.size }}
						-FN1 {% for item in target.keil_5_flash_algorithms -%}
						-FF{{ loop.index0 }}{{ item.name }} -FS{{ loop.index0 }}{{ item.base }} -FL{{ loop.index0 }}{{ item.size }}
						{%- if item.path != none %} -FP{{ loop.index0 }}($$Device:{{ target.name }}${{ item.path }}) {% endif %}
						{% endfor -%}
{{ '\n' }}					</Name>
				</SetRegEntry>
{%- endmacro %}
{# CMSIS_DAP debug description inside <DebugDescription> tag #}
{% macro cmsis_dap_debug_desc(speed) -%}
{% set speed_hz = speed * 1000 %}
	<Enable>1</Enable>
	<EnableFlashSeq>0</EnableFlashSeq>
	<EnableLog>0</EnableLog>
	<Protocol>2</Protocol>
	<DbgClock>{{ speed_hz }}</DbgClock>
{%- endmacro %}
{# BEGIN FILE CONTENTS ---------------------------------------------------------------------------------------------- #}
<?xml version="1.0" encoding="UTF-8"?>
<ProjectOpt xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="project_opt.xsd">
	<Target>
		<TargetName>{{ project.name }}</TargetName>
		<ToolsetNumber>0x4</ToolsetNumber>
		<ToolsetName>ARM-ADS</ToolsetName>
		<TargetOption>
			<CLKADS>{{ target.clock }}</CLKADS>
			<OPTTT>
				<gFlags>1</gFlags>
				<BeepAtEnd>1</BeepAtEnd>
				<RunSim>0</RunSim>
				<RunTarget>1</RunTarget>
			</OPTTT>
			<OPTHX>
				<HexSelection>1</HexSelection>
				<FlashByte>65535</FlashByte>
				<HexRangeLowAddress>0</HexRangeLowAddress>
				<HexRangeHighAddress>0</HexRangeHighAddress>
				<HexOffset>0</HexOffset>
			</OPTHX>
			<OPTLEX>
				<PageWidth>79</PageWidth>
				<PageLength>66</PageLength>
				<TabStop>8</TabStop>
				<ListingPath>.\Listings\</ListingPath>
			</OPTLEX>
			<ListingPage>
				<CreateCListing>1</CreateCListing>
				<CreateAListing>1</CreateAListing>
				<CreateLListing>1</CreateLListing>
				<CreateIListing>0</CreateIListing>
				<AsmCond>1</AsmCond>
				<AsmSymb>1</AsmSymb>
				<AsmXref>0</AsmXref>
				<CCond>1</CCond>
				<CCode>0</CCode>
				<CListInc>0</CListInc>
				<CSymb>0</CSymb>
				<LinkerCodeListing>0</LinkerCodeListing>
			</ListingPage>
			<OPTXL>
				<LMap>1</LMap>
				<LComments>1</LComments>
				<LGenerateSymbols>1</LGenerateSymbols>
				<LLibSym>1</LLibSym>
				<LLines>1</LLines>
				<LLocSym>1</LLocSym>
				<LPubSym>1</LPubSym>
				<LXref>0</LXref>
				<LExpSel>0</LExpSel>
			</OPTXL>
			<OPTFL>
				<tvExp>1</tvExp>
				<tvExpOptDlg>0</tvExpOptDlg>
				<IsCurrentTarget>1</IsCurrentTarget>
			</OPTFL>
			<CpuCode>{{ target.cpu_code }}</CpuCode>
			{% set tools = {
					'jlink': {
						'dbg_opt': jlink_dbg_opt,
						'dll': jlink_dll,
			            'dbg_desc': jlink_debug_desc,
					},
					'cmsis-dap': {
						'dbg_opt': cmsis_dap_dbg_opt,
						'dll': cmsis_dap_dll,
			            'dbg_desc': cmsis_dap_debug_desc,
					},
				}
			%}
			<DebugOpt>
				{{ tools[project.debug.tool].dbg_opt }}
			</DebugOpt>
			<TargetDriverDllRegistry>
				{{ tools[project.debug.tool].dll(target, project.debug.interface, project.debug.speed, project.debug.connect, project.debug.reset, project.debug.download) }}
			</TargetDriverDllRegistry>
			<DebugFlag>
				<trace>0</trace>
				<periodic>1</periodic>
				<aLwin>1</aLwin>
				<aCover>0</aCover>
				<aSer1>0</aSer1>
				<aSer2>0</aSer2>
				<aPa>0</aPa>
				<viewmode>1</viewmode>
				<vrSel>0</vrSel>
				<aSym>0</aSym>
				<aTbox>0</aTbox>
				<AscS1>0</AscS1>
				<AscS2>0</AscS2>
				<AscS3>0</AscS3>
				<aSer3>0</aSer3>
				<eProf>0</eProf>
				<aLa>0</aLa>
				<aPa1>0</aPa1>
				<AscS4>0</AscS4>
				<aSer4>0</aSer4>
				<StkLoc>1</StkLoc>
				<TrcWin>0</TrcWin>
				<newCpu>0</newCpu>
				<uProt>0</uProt>
			</DebugFlag>
			<LintExecutable />
			<LintConfigFile />
			<DebugDescription>
            {{ tools[project.debug.tool].dbg_desc(project.debug.speed) }}
			</DebugDescription>
		</TargetOption>
	</Target>
</ProjectOpt>
