Metadata-Version: 2.1
Name: fastapi-channels
Version: 0.0.1b2
Summary: This project provides a simple setup for creating WebSocket communication channels using FastAPI.
Keywords: fastapi,broadcaster,pydantic,fastapi-channels,limits
Author-Email: BXZDYG <banxingzhedeyangguang@gmail.com>
Classifier: Operating System :: OS Independent
Classifier: Intended Audience :: Information Technology
Classifier: Intended Audience :: System Administrators
Classifier: Typing :: Typed
Classifier: Development Status :: 4 - Beta
Classifier: Environment :: Web Environment
Classifier: Framework :: AsyncIO
Classifier: Framework :: FastAPI
Classifier: Framework :: Pydantic
Classifier: Framework :: Pydantic :: 1
Classifier: Intended Audience :: Developers
Classifier: License :: OSI Approved :: MIT License
Classifier: Programming Language :: Python
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3 :: Only
Classifier: Programming Language :: Python :: 3.8
Classifier: Programming Language :: Python :: 3.9
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Classifier: Topic :: Internet
Classifier: Topic :: Internet :: WWW/HTTP
Classifier: Topic :: Internet :: WWW/HTTP :: HTTP Servers
Classifier: Topic :: Software Development
Classifier: Topic :: Software Development :: Libraries
Classifier: Topic :: Software Development :: Libraries :: Python Modules
Project-URL: Homepage, https://github.com/YGuang233/fastapi-channels
Project-URL: Documentation, https://fc.bxzdyg.cn/
Project-URL: Repository, https://github.com/YGuang233/fastapi-channels
Project-URL: Issues, https://github.com/YGuang233/fastapi-channels/issues
Project-URL: Changelog, https:/fc.bxzdyg.cn/release-notes/
Requires-Python: >=3.8
Requires-Dist: fastapi>=0.110.0
Requires-Dist: broadcaster>=0.3.1
Requires-Dist: limits>=3.12.0
Requires-Dist: pydantic!=1.8,!=1.8.1,!=2.0.0,!=2.0.1,!=2.1.0,<3.0.0,>=1.7.4
Requires-Dist: typing-extensions>=4.8.0
Provides-Extra: standard
Requires-Dist: fastapi[standard]>=0.110.0; extra == "standard"
Provides-Extra: all
Requires-Dist: fastapi[all]>=0.110.0; extra == "all"
Provides-Extra: redis
Requires-Dist: redis; extra == "redis"
Requires-Dist: fastapi_limiter<=0.1.6; extra == "redis"
Provides-Extra: postgres
Requires-Dist: asyncpg; extra == "postgres"
Provides-Extra: kafka
Requires-Dist: aiokafka; extra == "kafka"
Provides-Extra: test
Requires-Dist: pytest; extra == "test"
Requires-Dist: pytest-asyncio; extra == "test"
Description-Content-Type: text/markdown

# FastAPI-Channels

<p align="center">
  <a href="https://python.org">
    <img src="https://img.shields.io/badge/Python-3.8+-yellow?style=for-the-badge&logo=python&logoColor=white&labelColor=101010" alt="">
  </a>
  <a href="https://fastapi.tiangolo.com">
    <img src="https://img.shields.io/badge/FastAPI-0.111.0-00a393?style=for-the-badge&logo=fastapi&logoColor=white&labelColor=101010" alt="">
  </a>
</p>

## ä»‹ç»
[ã€ä¸­æ–‡æ–‡æ¡£ã€‘](./README.md) [ã€English Docã€‘](./doc/README_EN.md)

&nbsp;&nbsp;æœ¬é¡¹ç›®ä¸»è¦ä¸ºFastAPIçš„WebSocketæ¥å£é€šè®¯æä¾›å¿«æ·æ–¹ä¾¿çš„æ‰©å±•åº“ã€‚ç‰¹è‰²åœ¨äºå°‘é‡ä»£ç å°±èƒ½å®ç°åŸºæœ¬çš„èŠå¤©å®¤çš„åŠŸèƒ½,å’Œfastapiçš„ç¼–å†™é£æ ¼ã€‚
<br>
&nbsp;&nbsp;æœ¬é¡¹ç›®åˆé›†æˆäº†ä¼˜ç§€çš„ç¬¬ä¸‰æ–¹åº“å¦‚:[broadcaster](https://github.com/encode/broadcaster)ã€[fastapi-limiter](https://github.com/long2ice/fastapi-limiter)ã€‚åœ¨æœ¬é¡¹ç›®å‡ä¿ç•™äº†è‡ªå®šä¹‰ä½¿ç”¨è¿™äº›åº“çš„ä½ç½®ã€‚
<br>
&nbsp;&nbsp;ä¸€èˆ¬çš„ï¼Œç”¨æˆ·ä½¿ç”¨æœ¬åº“ä»…éœ€è€ƒè™‘å¦‚ä½•ç¼–å†™ `action` æ¥å®ç°ä¼ è¾“çš„ç›®æ ‡,å’Œå¯¹åº”çš„`action`è®¿é—®çš„æƒé™ç±»å³å¯

## æ¡ˆä¾‹æ¼”ç¤º

<img src="https://github.com/user-attachments/assets/593ba9c9-4b23-46bf-8697-bee953372010" alt='WebSockets Demo'>

```python
from typing import Type, Union, Any, Optional

from starlette.requests import Request
from starlette.templating import Jinja2Templates
from fastapi import FastAPI, WebSocket
from pydantic import BaseModel
from fastapi_channels import add_channel
from fastapi_channels.channels import BaseChannel, Channel
from fastapi_channels.decorators import action
from fastapi_channels.exceptions import PermissionDenied
from fastapi_channels.permission import AllowAny
from fastapi_channels.throttling import limiter
from fastapi_channels.used import PersonChannel, GroupChannel

from path import TemplatePath  # è¿è¡Œæ­¤æ¡ˆä¾‹ï¼Œè¯·å°†å®Œæ•´çš„exampleæ–‡ä»¶å…‹éš†

templates = Jinja2Templates(TemplatePath)
app = FastAPI()
add_channel(app, url="redis://localhost:6379", limiter_url="redis://localhost:6379")

global_channels_details = {}


def add_global_channels_details(
        channel: Union[Type[BaseChannel], BaseChannel], name: str
) -> tuple[BaseChannel, str]:
    # æ£€æŸ¥ä¼ å…¥çš„æ˜¯ç±»è¿˜æ˜¯å®ä¾‹,ä½†æ˜¯è¿”å›çš„éƒ½æ˜¯å®ä¾‹å¯¹è±¡ï¼Œä¸åšé‡å¤çš„å®ä¾‹åŒ–
    if isinstance(channel, type):
        instance = channel()
    else:
        instance = channel

    actions = getattr(instance, "actions", [])
    if BaseChannel in type(instance).__bases__ and type(instance) is not Channel:
        room_type = "base_channel"
    else:
        room_type = "channel"
        assert actions != [], "You should set at least one action"

    global_channels_details[type(instance).__name__] = {
        "action": actions,
        "room": room_type,
        "name": name,
    }
    return instance, name


@app.get("/")
async def homepage(request: Request):
    template = "index.html"
    context = {"request": request, "channels": global_channels_details}
    return templates.TemplateResponse(
        template,
        context,
    )


class ResponseModel(BaseModel):
    action: str
    user: str
    message: Any
    status: str = 'ok'
    errors: Optional[str] = None
    request_id: int = 1

    def create(self) -> str:
        return self.model_dump_json(exclude_none=True)


class BaselChatRoom(BaseChannel): ...


base_chatroom, base_chatroom_name = add_global_channels_details(
    BaselChatRoom, name="chatroom_ws_base"
)


@app.websocket("/base", name=base_chatroom_name)
async def base_chatroom_ws(websocket: WebSocket):
    await base_chatroom.connect(websocket)


class PersonalChatRoom(PersonChannel):
    @staticmethod
    async def encode_json(data: dict) -> str:
        return ResponseModel(**data).create()

    @limiter(times=2, seconds=3000)  # è¯·æ±‚è¶…é¢ ä½†æ˜¯ä¸å…³é—­websocket
    @action("count")
    async def get_count(self, websocket: WebSocket, channel: str, data: dict, **kwargs):
        data.update({'message': await self.get_connection_count(channel)})
        await self.broadcast_to_personal(websocket, data)

    @action("message")  # å¹¿æ’­æ¶ˆæ¯
    async def send_message(
            self, websocket: WebSocket, channel: str, data: dict, **kwargs
    ):
        await self.broadcast_to_channel(channel, data)

    @action(deprecated=True)  # actionè¢«åºŸå¼ƒä¸å…³é—­websocket
    async def deprecated_action(
            self, websocket: WebSocket, channel: str, data: dict, **kwargs
    ):
        data.update({"message": "å‘é€æ¶ˆæ¯"})
        await self.broadcast_to_personal(websocket, data)

    @action("permission_denied", permission=False)  # è¿”å›æƒé™ä¸è¶³çš„é”™è¯¯å“åº”
    async def permission_false(
            self, websocket: WebSocket, channel: str, data: dict, **kwargs
    ):
        await self.broadcast_to_channel(channel, data)

    @action(permission=AllowAny)  # æŠ›å‡ºå¼‚å¸¸ä¸ä½†å…³é—­websocket
    async def error(self, websocket: WebSocket, channel: str, data: dict, **kwargs):
        raise PermissionDenied(close=False)

    @action()  # å®¢æˆ·ç«¯é€šè¿‡closeçš„actionå¯ä»¥ä¸»åŠ¨å…³é—­websocketè¿æ¥
    async def close(self, websocket: WebSocket, channel: str, data: dict, **kwargs):
        await websocket.close()


person_chatroom, person_chatroom_name = add_global_channels_details(
    PersonalChatRoom(), name="chatroom_ws_person"
)


@app.websocket("/person", name=person_chatroom_name)
async def person_chatroom_ws(websocket: WebSocket):
    await person_chatroom.connect(websocket, channel="person_channel")


class GroupChatRoom(GroupChannel):
    @staticmethod
    async def encode_json(data: dict) -> str:
        return ResponseModel(**data).create()


group_chatroom = GroupChatRoom()
group_chatroom_name = "chatroom_ws_group"


@app.websocket("/group", name=group_chatroom_name)
async def group_chatroom_ws(websocket: WebSocket):
    await group_chatroom.connect(websocket, channel="group_channel")


async def join_room(
        websocket: WebSocket,
        channel: str,
):
    await group_chatroom.broadcast_to_personal(websocket, "Join successfully")


async def leave_room(
        websocket: WebSocket,
        channel: str,
):
    # await group_chatroom.broadcast_to_personal(websocket, 'leave successfully')
    # error: ğŸ‘†å¦‚æœé€šè¿‡actionç¦»å¼€æˆ¿é—´ä¼šè¾“å‡ºè¿™ä¸ªï¼Œä½†æ˜¯å®¢æˆ·ç«¯ç›´æ¥å…³é—­ä¼šè¯±å‘websocketæ²¡æœ‰è¿›è¡Œè¿æ¥
    # æ‰€ä»¥è¿™ä¸€æ­¥åªèƒ½`broadcast_to_channel`æˆ–è€…åç»­å¤„ç†,è€Œä¸æ˜¯`broadcast_to_personal`
    await group_chatroom.broadcast_to_channel(channel, "leave successfully")


# ä»¥å‡½æ•°çš„å½¢å¼æ³¨å†ŒåŠ å…¥æˆ¿é—´å’Œé€€å‡ºæˆ¿é—´çš„æ“ä½œæ˜¯å¯ä»¥è¿›è¡Œå¹¿æ’­åˆ°é¢‘é“ä¸­,åƒfastapié‚£æ ·
group_chatroom.add_event_handler("join", join_room)
group_chatroom.add_event_handler("leave", leave_room)


# è€Œä»¥ç±»çš„å½¢å¼é€šè¿‡å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ¥å®ç°é¢‘é“çš„å‘¨æœŸå´æ˜¯ä¸è¡Œçš„
# import contextlib
# @contextlib.asynccontextmanager
# async def lifespan(self, websocket: WebSocket, channel: str, ):
#     # await person_chatroom.broadcast_to_channel(channel, 'Join successfully')
#     # yield
#     # await person_chatroom.broadcast_to_channel(channel, 'leave successfully')
#     await PersonalChatRoom.broadcast_to_channel(channel, 'Join successfully')
#     yield
#     await person_chatroom.broadcast_to_channel(channel, 'leave successfully')
# person_chatroom = PersonalChatRoom(lifespan=lifespan)
# å› ä¸ºè¿™é‡Œçš„channelæ˜¯åœ¨å®ä¾‹åŒ–åçš„`connect`ä¸­è¢«ä¼ å…¥çš„`ï¼Œå› ä¸ºæˆ‘å°†ä¸€äº›lifespançš„æ“ä½œæ”¾åˆ°äº†channel,æœ‰ç€æå¤§çš„è€¦åˆï¼Œåç»­å°†è§£å†³è¿™ä¸ªé—®é¢˜


@limiter(times=1, seconds=3)
@group_chatroom.action("message")  # æ¶ˆæ¯å‘é€è§£æå’Œ#è£…é¥°å™¨å¼‚å¸¸
async def send_message(websocket: WebSocket, channel: str, data: dict, **kwargs):
    await group_chatroom.broadcast_to_channel(channel, data)


@group_chatroom.action("error_true")  # è§¦å‘å¼‚å¸¸ï¼Œä¸»æœºå…³é—­è¿æ¥
async def send_error_and_close(
        websocket: WebSocket, channel: str, data: dict, **kwargs
):
    raise PermissionDenied(close=True)


@group_chatroom.action("error_false")  # æ¶ˆæ¯å‘é€è§£æå’Œå¼‚å¸¸
async def send_error(websocket: WebSocket, channel: str, data: dict, **kwargs):
    raise PermissionDenied(close=False)


@group_chatroom.action()  # å®¢æˆ·ç«¯å‘é€šè¿‡`action`è¯·æ±‚ä¸»æœºå…³é—­è¿æ¥
async def close(websocket: WebSocket, channel: str, data: dict, **kwargs):
    await websocket.close()


_, _ = add_global_channels_details(group_chatroom, group_chatroom_name)

if __name__ == "__main__":
    import uvicorn

    uvicorn.run(app, port=8000)

```
å‰ç«¯çš„HTMLæ¨¡æ¿[å¯åœ¨æ­¤å¤„è·å¾—](https://github.com/YGuang233/fastapi-channels/blob/master/example/templates/index.html)ï¼Œæ”¹ç¼–è‡ª[Pieter Noordhuisçš„PUB/SUBæ¼”ç¤º](https://gist.github.com/pietern/348262)å’Œ[Tom Christieçš„Broadcasteræ¼”ç¤º](https://github.com/encode/broadcaster/blob/master/example/templates/index.html)

è¿è¡Œæ­¤æ¡ˆä¾‹è¯·å°†æ•´ä¸ªexampleæ–‡ä»¶è¿›è¡Œclone

<a href="https://fc.bxzdyg.com/zh/tutorial/">æ•™ç¨‹ - ç”¨æˆ·æŒ‡å—</a> ä¸­æœ‰åŒ…å«æ›´å¤šç‰¹æ€§çš„æ›´å®Œæ•´ç¤ºä¾‹ã€‚

## ç›®æ ‡å’Œå®ç°

- [x] æƒé™è®¤è¯
    - [x] åŸºç¡€å…¨å±€ã€é¢‘é“æƒé™è®¤è¯
    - [x] è®¿é—®`action`çš„æƒé™éªŒè¯
    - [ ] åŸºç¡€çš„ç”¨æˆ·éªŒè¯çš„æ–¹æ¡ˆ
- [x] è‡ªå®šä¹‰å¼‚å¸¸å’Œå…¨å±€æ•è·,å¹¶ä¸”æŠ›å‡ºå¼‚å¸¸å¯æ§è¿æ¥çŠ¶æ€
- [ ] é¢å¤–çš„æ—¥å¿—è®°å½•
- [ ] åˆ†é¡µå™¨
- [x] é™æµå™¨
    - [x] fastapi-limiter
- [ ] å…¼å®¹å¤šç§è¯·æ±‚ç±»å‹çš„æ”¯æŒ
    - [ ] Text
    - [x] JSON
    - [ ] Binary
- [x] é¢‘é“äº‹ä»¶
    - [x] é¢‘é“ç”Ÿå‘½å‘¨æœŸäº‹ä»¶(lifespanã€on_event)
- [ ] å¯è‡ªå®šä¹‰æ•°æ®ä¼ è¾“çš„ç»“æ„
    - [ ] è¯·æ±‚ä½“
    - [ ] å“åº”ä½“
    - [ ] åˆ†é¡µå™¨
- [ ] æŒä¹…åŒ–
    - [ ] å†å²è®°å½•çš„å­˜å‚¨
    - [ ] å†å²è®°å½•çš„è¯»å–
- [ ] åå°ç®¡ç†
    - [ ] Apiæ¥å£æ§åˆ¶
    - [ ] å®šæ—¶ç®¡ç†
- [ ] å›½é™…åŒ–
- [ ] æµ‹è¯•ç¯å¢ƒæ­å»º
- [ ] å®Œå–„çš„doc
- [ ] fastapiç¼–å†™é£æ ¼åŒ–(ä¾èµ–é¡¹æ³¨å…¥...)

## å®‰è£…

é‚£ä¹ˆæ¥ä¸‹æ¥å°±ç”±ä½ æ¥ä½¿ç”¨fastapi-channelsäº†
```shell
pip install fastapi-channels
```

## è®¸å¯åè®®

è¯¥é¡¹ç›®éµå¾ª MIT è®¸å¯åè®®ã€‚
