{% import 'macros.jinja' as macros %}

<div id="printer-response"></div>

{% set device_count = printers|length + pending_printers|length %}
{% set recommend_count = request.putil.get_recommend_max_client_count() %}
{% set is_using_too_many_res = request.putil.is_using_too_many_resources() %}
{% set has_too_many_printers = device_count > recommend_count %}

{% if "dismiss-bambu-warning" not in request.cookies and (is_using_too_many_res or has_too_many_printers) %}
    {% if is_using_too_many_res %}
        <div id="bambu-warning"
             class="alert alert-danger"
             role="alert">

            <strong>This device is currently using {{ request.putil.get_memory_usage() }} memory
                and {{ request.putil.get_cpu_usage() }} cpu</strong>

            <button type="button"
                    class="btn btn-sm btn-outline-danger m-2 position-absolute"
                    style="top: 0; right: 0"
                    hx-post="{{ url_for('api.dismiss_bambu_warning') }}"
                    hx-target="#bambu-warning"
                    hx-swap="outerHTML">
                Dismiss
            </button>
            <br>

            Your device is experiencing increased resource usage, this can cause performance issues.

            {{ macros.externalLink("Having trouble with performance?", "https://help.simplyprint.io/en/article/z5o6uy") }}
        </div>
    {% elif has_too_many_printers %}
        <div id="bambu-warning"
             class="alert alert-warning"
             role="alert">
            <strong>The recommend amount of clients for your device is {{ recommend_count }} you
                have {{ device_count }}.</strong>


            <button type="button"
                    class="btn btn-sm btn-outline-danger m-2 position-absolute"
                    style="top: 0; right: 0"
                    hx-post="{{ url_for('api.dismiss_bambu_warning') }}"
                    hx-target="#bambu-warning"
                    hx-swap="outerHTML">
                Dismiss
            </button>
            <br>

            You have too many printers connected to your device, this can cause performance issues.

            {{ macros.externalLink("Having trouble with performance?", "https://help.simplyprint.io/en/article/z5o6uy") }}
        </div>
    {% endif %}
    {% include "hardware_warning.html" %}
{% endif %}

{% if printers|length == 0 and pending_printers|length == 0 %}
    <h3 class="mb-3"><strong>Printers</strong></h3>

    <div class="alert alert-info"
         role="alert">
        <strong>No printers</strong>
        <br>
        You don't have any connected printers yet.
        {{ macros.externalLink("Having trouble connecting your printer?", "https://help.simplyprint.io/en/article/xqlhtd") }}
    </div>

    <div class="row mb-3">
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card empty-card h-100 user-select-none">
                <a href="{{ url_for('printers.add_printer_view') }}" class="text-decoration-none text-light">
                    <div class="card-body text-center">
                        <h3 class="my-5">{{ macros.faPlus("text-white") }} Add first printer</h3>
                    </div>
                </a>
            </div>
        </div>
    </div>
{% endif %}

{% macro printerCard(printer) %}
    <div class="col-12 mb-3 col-md-6"
         id="printer-{{ printer.unique_id }}">
        <div class="card h-100">
            <div class="card-body d-flex flex-column justify-content-between">
                <div class="d-flex flex-row align-items-center">
                    <img src="{{ printer.product_image }}"
                         class="img-fluid mb-2"
                         width="100"
                         height="100"
                         alt="{{ printer.device_type.value }}"
                         title="{{ printer.device_type.value }}"
                         draggable="false">
                    <div class="w-100">
                        <div class="float-end d-inline user-select-none">
                            {# Mode badge #}
                            {% if printer.cloud_account %}
                                {# Display an invalid user account icon when account has been deleted. Click goes to accounts. #}
                                {% if printer.cloud_account and printer.invalid_cloud_account %}
                                    <a class="badge bg-body" tabindex="0" data-bs-toggle="tooltip"
                                       hx-boost="false" href="{{ url_for('bblcloud.accounts') }}"
                                       title="Bambu Lab account no longer exists, or authentication failed.">
                                        {{ macros.faUserSlash('text-danger') }}
                                    </a>
                                {% endif %}

                                <span class="badge bg-light-subtle">{{ macros.faCloud() }}</span>
                            {% else %}
                                <span class="badge bg-light-subtle">{{ macros.faHouseSignal() }}</span>
                            {% endif %}

                            {# State badge (far right)
                            output printer.state as
                            #}

                            <span class="badge {{ printer.state.color }}">{{ printer.state.label }}</span>

                        </div>

                        <h4 class="card-title">
                            {% if printer.name %}
                                <strong>{{ printer.name }}</strong>
                            {% else %}
                                <strong>In setup:</strong>
                                <span class="badge bg-primary mt-1 font-monospace"
                                      data-bs-toggle="tooltip"
                                      title="Setup code for this printer, can be used to set up the printer in the SimplyPrint panel">
                                    {{ printer.setup_code or '...' }}
                                </span>
                            {% endif %}
                        </h4>

                        <div class="mb-2">
                            <div>
                                <strong>Local IP:</strong>
                                <span class="user-select-all">{{ printer.ip }}</span>
                            </div>
                            <div>
                                <strong>Serial number:</strong>
                                <span class="user-select-all">{{ printer.sn }}</span>
                            </div>
                            <div>
                                <strong>Access code:</strong>
                                <span class="spoiler user-select-all">{{ printer.access_code }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="btn-group" role="group" aria-label="Actions">
                    {% if printer.name %}
                        <a type="button"
                           href="{{ printer.url }}"
                           class="btn btn-outline-primary"
                           target="_blank"
                           draggable="false">
                            View in SimplyPrint
                        </a>
                    {% elif printer.setup_code %}
                        <a type="button"
                           href="{{ printer.url }}"
                           class="btn btn-primary"
                           target="_blank"
                           draggable="false">
                            Set up in SimplyPrint
                        </a>
                    {% endif %}

                    <a type="button"
                       class="btn btn-outline-primary"
                       href="{{ url_for('printers.edit_printer_view', unique_id=printer.unique_id) }}"
                       hx-boost="false"
                    >
                        Edit
                    </a>

                    <button type="button"
                            class="btn btn-outline-danger"
                            hx-delete="{{ url_for('api.delete_printer', unique_id=printer.unique_id) }}"
                            hx-confirm="Are you sure you want to delete this printer? Please note that this will only delete the printer from the Bambu Lab connection, and not in the SimplyPrint panel."
                            hx-target="#printer-response">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endmacro %}

{% if pending_printers|length != 0 %}
    <h3 class=""><strong>Pending printers</strong></h3>
    <p class="text-muted">
        Once you have added a printer via this interface, it must be linked to your SimplyPrint account.
        Go to {{ macros.externalLink("the SimplyPrint web panel", "https://simplyprint.io/panel") }} to link your
        printer
        {% if pending_printers|length > 1 %}s{% endif %}.
    </p>

    <div class="row mb-3">
        {% for printer in pending_printers %}
            {{ printerCard(printer) }}
        {% endfor %}
    </div>
{% endif %}

{% if printers|length != 0 %}
    <h3 class="mb-3"><strong>Printers</strong></h3>

    <div class="row">
        {% for printer in printers %}
            {{ printerCard(printer) }}
        {% endfor %}
    </div>
{% endif %}
