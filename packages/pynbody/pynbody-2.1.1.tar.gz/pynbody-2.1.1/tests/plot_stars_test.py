import numpy.testing as npt
import pytest

import pynbody
import pynbody.test_utils


@pytest.fixture(scope='module', autouse=True)
def get_data():
    pynbody.test_utils.ensure_test_data_available("gasoline_ahf")

@pytest.fixture(scope='module')
def snap_and_halos():
    f = pynbody.load("testdata/gasoline_ahf/g15784.lr.01024")
    h = f.halos()
    return f, h

@pytest.mark.filterwarnings("ignore:No log file found:UserWarning")
def test_sb_profile(snap_and_halos):
    f, h = snap_and_halos
    r, sb, scale, norm = pynbody.plot.stars.sbprofile(h[0], fit_exp=0.5, rmax="10 kpc")

    r0 = [0.08668786, 0.20363257, 0.26737341, 0.31765363, 0.36105263,
          0.40083022, 0.43837936, 0.47334848, 0.50596223, 0.53760338,
          0.56816831, 0.59795692, 0.62673996, 0.65395354, 0.68057819,
          0.70709073, 0.73298487, 0.75822424, 0.7836805 , 0.8093996 ,
          0.83507254, 0.8610379 , 0.88669761, 0.91176888, 0.93723952,
          0.96312922, 0.9881676 , 1.01312917, 1.03909138, 1.06520541,
          1.09182385, 1.11933554, 1.14695448, 1.17487413, 1.20366801,
          1.23260409, 1.26163128, 1.29136675, 1.32160995, 1.35234374,
          1.38408093, 1.41684422, 1.4499145 , 1.48448826, 1.52011305,
          1.5555254 , 1.5921512 , 1.62962286, 1.66861317, 1.70949596,
          1.75156766, 1.79610226, 1.84239039, 1.88923863, 1.93738947,
          1.98675962, 2.03921791, 2.09416529, 2.15075787, 2.20951908,
          2.26993596, 2.33221602, 2.3980376 , 2.46568193, 2.5343601 ,
          2.60701291, 2.68318206, 2.76228225, 2.84401692, 2.92896421,
          3.01747621, 3.11133564, 3.21078164, 3.31458753, 3.42435416,
          3.53680731, 3.65264094, 3.77713345, 3.90884893, 4.04963752,
          4.20147324, 4.35771223, 4.51605302, 4.68337016, 4.85789164,
          5.0384083 , 5.22711524, 5.42946145, 5.64529882, 5.87271965,
          6.10884874, 6.36566983, 6.64798635, 6.95208341, 7.28470793,
          7.63983852, 8.02516699, 8.46691225, 9.00212771, 9.64897665]
    sb0 = [17.42195197, 17.53449664, 17.3675447 , 17.20107379, 17.52850742,
          17.43789114, 17.58919179, 17.45681541, 17.6237622 , 17.54153981,
          17.64388921, 17.75130042, 17.5263182 , 17.82194961, 17.68097217,
          17.8605491 , 17.72183402, 17.7986628 , 18.16779889, 17.97110663,
          18.08526397, 17.99532177, 18.09337333, 18.16614009, 18.38387064,
          18.31816202, 18.30093691, 18.18775143, 18.45516155, 18.35827492,
          18.60826625, 18.65485976, 18.66981905, 18.59949405, 18.80336233,
          18.81492511, 18.9726349 , 18.95995023, 18.9954286 , 19.0546457 ,
          19.17345713, 19.24560627, 19.2993787 , 19.37656886, 19.3362422 ,
          19.50420551, 19.3834054 , 19.56490771, 19.7370757 , 19.73039112,
          19.93853923, 19.99020319, 20.01493276, 20.0004941 , 20.051024  ,
          20.08421083, 20.250156  , 20.26661977, 20.11664608, 20.42257362,
          20.51502921, 20.49056193, 20.53187267, 20.53946984, 20.63686241,
          20.49230707, 20.74652125, 20.78446498, 20.79583696, 20.86935718,
          20.88411353, 21.06655498, 20.88447907, 21.02670464, 21.26886841,
          21.23239427, 21.45603704, 21.38433004, 21.6008905 , 21.65938612,
          21.79846221, 21.45032737, 21.76055776, 21.89892332, 21.86415924,
          21.69230811, 21.73767241, 22.14316606, 22.1629707 , 22.24153259,
          22.15274539, 22.3361127 , 22.25593221, 22.66165942, 22.65959801,
          22.6833113 , 22.64411064, 23.32178214, 23.55109494, 24.16194164]
    scale0 = 1.536457
    norm0 = 18.123411

    npt.assert_allclose(r, r0, rtol=1e-7)
    npt.assert_allclose(sb, sb0, rtol=1e-7)
    npt.assert_allclose(scale, scale0, rtol=1e-7)
    npt.assert_allclose(norm, norm0, rtol=1e-7)

@pytest.mark.filterwarnings("ignore:No log file found:UserWarning")
def test_sfh(snap_and_halos):
    f, h = snap_and_halos
    t, sfh = pynbody.plot.stars.sfh(h[0])

    t0 = [ 0.23160894,  0.36657633,  0.50154373,  0.63651112,  0.77147851,
           0.9064459 ,  1.04141329,  1.17638068,  1.31134807,  1.44631546,
           1.58128285,  1.71625024,  1.85121763,  1.98618502,  2.12115241,
           2.25611981,  2.3910872 ,  2.52605459,  2.66102198,  2.79598937,
           2.93095676,  3.06592415,  3.20089154,  3.33585893,  3.47082632,
           3.60579371,  3.7407611 ,  3.8757285 ,  4.01069589,  4.14566328,
           4.28063067,  4.41559806,  4.55056545,  4.68553284,  4.82050023,
           4.95546762,  5.09043501,  5.2254024 ,  5.36036979,  5.49533718,
           5.63030458,  5.76527197,  5.90023936,  6.03520675,  6.17017414,
           6.30514153,  6.44010892,  6.57507631,  6.7100437 ,  6.84501109,
           6.97997848,  7.11494587,  7.24991326,  7.38488066,  7.51984805,
           7.65481544,  7.78978283,  7.92475022,  8.05971761,  8.194685  ,
           8.32965239,  8.46461978,  8.59958717,  8.73455456,  8.86952195,
           9.00448935,  9.13945674,  9.27442413,  9.40939152,  9.54435891,
           9.6793263 ,  9.81429369,  9.94926108, 10.08422847, 10.21919586,
          10.35416325, 10.48913064, 10.62409803, 10.75906543, 10.89403282,
          11.02900021, 11.1639676 , 11.29893499, 11.43390238, 11.56886977,
          11.70383716, 11.83880455, 11.97377194, 12.10873933, 12.24370672,
          12.37867412, 12.51364151, 12.6486089 , 12.78357629, 12.91854368,
          13.05351107, 13.18847846, 13.32344585, 13.45841324, 13.59338063,
          13.72834802]

    sfh0 = [ 0.35855347,  1.56101938,  3.4456114 ,  5.32119741, 15.19657074,
          21.22159318, 30.07963412, 43.70868589, 47.28474849, 42.75664328,
          52.92601364, 62.54722538, 46.71281852, 52.67547379, 41.99851596,
          30.39877028, 28.04710316, 28.90193334, 27.98081876, 26.34093023,
          24.81153507, 21.75968903, 20.0778341 , 19.11956184, 17.9305885 ,
          16.6756488 , 17.96513369, 15.78863045, 12.36869897, 11.55602824,
          11.47672118, 10.2917112 ,  9.70704   ,  9.71972978, 10.27028945,
           9.74930048,  9.36958484,  8.53044963,  8.66610515,  8.51290009,
           8.54317933,  8.25448224,  7.86579607,  7.39748441,  7.15336397,
           6.89119156,  6.53635068,  6.78163586,  6.36162173,  6.18236408,
           5.74970147,  5.46508479,  5.73229865,  5.58381441,  5.44771686,
           5.10256262,  4.80111842,  4.93139337,  5.52204463,  5.02788058,
           4.40733215,  4.21518958,  4.1403365 ,  4.4552328 ,  4.11007103,
           4.03525989,  3.56364822,  3.68580178,  4.06211697,  3.69896696,
           3.47161382,  3.81267958,  3.57678949,  3.30952793,  3.49371003,
           3.30099964,  3.12186234,  3.15215854,  3.24447164,  3.26196206,
           3.11306531,  2.98182771,  3.04333189,  2.98204232,  3.20074561,
           3.07375322,  2.98641521,  2.824613  ,  2.74526299,  3.19163668,
           2.92078668,  3.08228986,  3.12615621,  3.33629631,  3.36681181,
           3.37122513,  3.33166896,  3.39289043,  3.49792132,  3.42365663]

    npt.assert_allclose(t, t0, atol=1e-5)
    npt.assert_allclose(sfh, sfh0, atol=1e-5)
