<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Span Visualization</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.12.0/cdn.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.3.0/luxon.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .task-bar {
            position: relative;
            height: 16px;
            border-radius: 2px;
            opacity: 0.8;
        }
        .toggle-icon {
            transition: transform 0.2s ease;
            display: inline-block;
            width: 20px;
            text-align: center;
            cursor: pointer;
        }
        .toggle-icon.expanded {
            transform: rotate(90deg);
        }
        body {
            background-color: #0f1924;
            color: #e6edf3;
        }
        .task-info {
            font-family: monospace;
        }
        .task-row {
            display: flex;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #1c2a3a;
        }
        .task-row:hover {
            background-color: #1c2a3a;
        }
        .timestamp {
            font-family: monospace;
            color: #8b949e;
        }
        .detail-panel {
            background-color: #1c2a3a;
            border-radius: 4px;
        }
    </style>
</head>
<body class="p-4 m-0">
    <div class="min-h-screen" x-data="taskData()">
        <div class="flex">
            <!-- Task list (left) -->
            <div class="w-1/2 border-r border-gray-800">
                <!-- Parent task row -->
                <div class="task-row" 
                     @mouseenter="selectedTask = allTasks[0]"
                     @mouseleave="selectedTask = null">
                    
                    <div class="timestamp w-24 pl-4" x-text="formatTime(allTasks[0].start_time)"></div>

                    <div class="task-info flex-grow overflow-hidden whitespace-nowrap text-ellipsis flex items-center">
                        <span class="toggle-icon mr-2" 
                              :class="{'expanded': expanded}"
                              @click.stop="expanded = !expanded">â–¶</span>
                        <span x-text="allTasks[0].task_name"></span>
                    </div>
                    
                    <div class="flex-grow-0 w-1/2 px-4 relative">
                        <div class="task-bar bg-green-400" 
                             :style="`left: ${timeToPosition(new Date(allTasks[0].start_time))}%; width: ${durationToWidth(allTasks[0].duration)}%;`">
                        </div>
                    </div>
                </div>
                
                <!-- Subtasks rows (only visible when expanded) -->
                <template x-for="(subtask, index) in allTasks.slice(1)" :key="subtask.id">
                    <div class="task-row" 
                         x-show="expanded"
                         @mouseenter="selectedTask = subtask"
                         @mouseleave="selectedTask = null">
                        
                        <div class="timestamp w-24 pl-4" x-text="formatTime(subtask.start_time)"></div>

                        <div class="task-info flex-grow overflow-hidden whitespace-nowrap text-ellipsis pl-8"
                             x-text="subtask.task_name"></div>
                        
                        <div class="flex-grow-0 w-1/2 px-4 relative">
                            <div class="task-bar bg-green-400" 
                                 :style="`left: ${timeToPosition(new Date(subtask.start_time))}%; width: ${durationToWidth(subtask.duration)}%;`">
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            
            <!-- Detail panel (right) -->
            <div class="w-1/2 pl-4">
                <div class="detail-panel p-4 h-full" x-show="selectedTask">
                    <template x-if="selectedTask">
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-lg" x-text="'Task Details'"></h3>
                                <div class="bg-gray-700 px-2 py-1 rounded text-xs" x-text="`Duration: ${selectedTask.duration.toFixed(2)}ms`"></div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="text-gray-400 text-sm">Name</div>
                                <div class="font-mono text-sm" x-text="selectedTask.task_name"></div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="text-gray-400 text-sm">Start Time</div>
                                <div class="font-mono text-sm" x-text="formatDateTime(selectedTask.start_time)"></div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="text-gray-400 text-sm">End Time</div>
                                <div class="font-mono text-sm" x-text="formatDateTime(selectedTask.end_time)"></div>
                            </div>
                            
                            <template x-if="selectedTask.inputs && Object.keys(selectedTask.inputs).length > 0">
                                <div class="mb-4">
                                    <div class="text-gray-400 text-sm">Inputs</div>
                                    <div class="font-mono text-sm bg-gray-800 p-2 rounded mt-1 overflow-auto">
                                        <pre x-text="JSON.stringify(selectedTask.inputs, null, 2)"></pre>
                                    </div>
                                </div>
                            </template>
                            
                            <template x-if="selectedTask.output">
                                <div class="mb-4">
                                    <div class="text-gray-400 text-sm">Output</div>
                                    <div class="font-mono text-sm bg-gray-800 p-2 rounded mt-1 overflow-auto">
                                        <div x-text="selectedTask.output"></div>
                                    </div>
                                </div>
                            </template>
                            
                            <template x-if="selectedTask.logs && selectedTask.logs.length > 0">
                                <div class="mb-4">
                                    <div class="text-gray-400 text-sm">Logs</div>
                                    <div class="font-mono text-sm bg-gray-800 p-2 rounded mt-1 overflow-auto">
                                        <template x-for="log in selectedTask.logs">
                                            <div class="mb-1">
                                                <span class="text-gray-400" x-text="log[0] + ':'"></span>
                                                <span x-text="log[1]"></span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <script>
        function taskData() {
            const data = {
                "id": "af7cd2d8-06e9-4278-9dd0-351c094afa4f",
                "task_name": "CALLING: run_concurrent_tasks",
                "task_type": "parent",
                "start_time": "2025-04-12T21:36:35.749665+00:00",
                "duration": 3.0015041250153445,
                "inputs": {},
                "error": null,
                "error_traceback": null,
                "retry_count": 0,
                "artifacts": {},
                "table": {},
                "end_time": "2025-04-12T21:36:38.751149+00:00",
                "subtasks": [
                    {
                        "id": "5bffd8b8-b241-4f4c-946e-bf2bbf4f87bc",
                        "task_name": "CALLING: async_sleep",
                        "task_type": "subtask",
                        "start_time": "2025-04-12T21:36:35.749853+00:00",
                        "duration": 1.0011603330203798,
                        "inputs": {
                            "arg0": 1,
                            "arg1": "Task 2"
                        },
                        "error": null,
                        "error_traceback": null,
                        "retry_count": 0,
                        "artifacts": {},
                        "table": {},
                        "end_time": "2025-04-12T21:36:36.751066+00:00",
                        "logs": [
                            [
                                "INFO",
                                "it works, right?",
                                "2025-04-12T21:36:35.749930+00:00"
                            ]
                        ],
                        "output": "Task 2 finished sleeping for 1 seconds"
                    },
                    {
                        "id": "86984611-bcd3-4dcb-8b98-d7c05d9ba64b",
                        "task_name": "CALLING: async_sleep",
                        "task_type": "subtask",
                        "start_time": "2025-04-12T21:36:35.749779+00:00",
                        "duration": 2.000852583005326,
                        "inputs": {
                            "arg0": 2,
                            "arg1": "Task 1"
                        },
                        "error": null,
                        "error_traceback": null,
                        "retry_count": 0,
                        "artifacts": {},
                        "table": {},
                        "end_time": "2025-04-12T21:36:37.750606+00:00",
                        "logs": [
                            [
                                "INFO",
                                "it works, right?",
                                "2025-04-12T21:36:35.749804+00:00"
                            ]
                        ],
                        "output": "Task 1 finished sleeping for 2 seconds"
                    },
                    {
                        "id": "b51197f9-eeff-47e2-8a80-095a36677074",
                        "task_name": "CALLING: async_sleep",
                        "task_type": "subtask",
                        "start_time": "2025-04-12T21:36:35.749964+00:00",
                        "duration": 3.001122834015405,
                        "inputs": {
                            "arg0": 3,
                            "arg1": "Task 3"
                        },
                        "error": null,
                        "error_traceback": null,
                        "retry_count": 0,
                        "artifacts": {},
                        "table": {},
                        "end_time": "2025-04-12T21:36:38.751033+00:00",
                        "logs": [
                            [
                                "INFO",
                                "it works, right?",
                                "2025-04-12T21:36:35.749986+00:00"
                            ]
                        ],
                        "output": "Task 3 finished sleeping for 3 seconds"
                    }
                ]
            };

            // Calculate global start and end times
            const startTime = new Date(data.start_time);
            let endTime = new Date(data.end_time);
            
            // Create flattened array for display
            const allTasks = [];
            
            // Add parent task first
            allTasks.push({
                ...data,
                task_type: "parent"
            });
            
            // Add all subtasks
            if (data.subtasks) {
                data.subtasks.forEach(subtask => {
                    allTasks.push({
                        ...subtask,
                        task_type: "subtask"
                    });
                });
            }
            
            // Sort by start time
            allTasks.sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
            
            const totalDuration = (endTime - startTime) / 1000; // in seconds

            return {
                taskData: data,
                allTasks: allTasks,
                startTime,
                endTime,
                totalDuration,
                selectedTask: null,
                expanded: true, // Controls visibility of subtasks
                
                timeToPosition(time) {
                    return ((time - this.startTime) / (this.endTime - this.startTime)) * 100;
                },
                
                durationToWidth(duration) {
                    return (duration / this.totalDuration) * 100;
                },
                
                formatTime(timeString) {
                    const time = new Date(timeString);
                    return time.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second: '2-digit'});
                },
                
                formatDateTime(dateString) {
                    if (!dateString) return '';
                    const dt = luxon.DateTime.fromISO(dateString);
                    return dt.toFormat('HH:mm:ss.SSS');
                }
            };
        }
    </script>
</body>
</html>