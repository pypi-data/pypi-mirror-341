{% load static %}
<!-- 直接从 CDN 加载 Textbus 的静态文件 -->
<link href="https://unpkg.com/@textbus/editor@3.8.4/bundles/textbus.min.css" rel="stylesheet">
<script src="https://unpkg.com/@textbus/editor@3.8.4/bundles/textbus.min.js"></script>

<style>
    .textbus-container {
        margin-bottom: 15px;
    }
    .textbus-editor-container {
        min-height: 300px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
</style>

<div class="textbus-container">
    <textarea name="{{ widget.name }}" data-config='{{ widget.config_json|safe }}'{% if widget.attrs %}{% for name, value in widget.attrs.items %}{% if value is not False %} {{ name }}{% if value is not True %}="{{ value }}"{% endif %}{% endif %}{% endfor %}{% endif %}>{{ widget.value }}</textarea>
    <div id="textbus-editor-{{ widget.attrs.id }}" class="textbus-editor-container"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const textareaId = "{{ widget.attrs.id }}";
        const textarea = document.getElementById(textareaId);
        const editorContainer = document.getElementById("textbus-editor-" + textareaId);

        // 初始化Textbus编辑器
        const config = {{ widget.config_json|safe }};

        // 创建Textbus实例
        try {
            const textbus = new Textbus.Editor({
                ...config,
                content: textarea.value,
                container: editorContainer
            });

            // 当编辑器内容变化时，更新textarea的值
            textbus.onChange.subscribe(content => {
                textarea.value = content;
            });

            // 隐藏原始textarea
            textarea.style.display = 'none';
        } catch (e) {
            console.error('初始化Textbus编辑器时出错:', e);
            editorContainer.innerHTML = '<div style="color: red; padding: 10px; border: 1px solid red;">初始化Textbus编辑器失败。请确保已正确加载Textbus库。</div>';
        }
    });
</script>
