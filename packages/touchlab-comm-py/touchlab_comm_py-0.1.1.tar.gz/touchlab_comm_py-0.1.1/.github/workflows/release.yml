name: Build and Release tag Linux

on:
  pull_request:
  # push:
  #   tags:
  #   - '*'

jobs:
  build_sdist:
    name: Build SDist
    runs-on: [self-hosted, linux, x64]
    steps:
    - uses: actions/checkout@v4
    - name: Checkout submodules
      run: |
        git submodule update --init --recursive

    - name: Build SDist
      run: python -m build --sdist

    - name: Check metadata
      run: pipx run twine check dist/*

    - uses: actions/upload-artifact@v4
      with:
        name: cibw-sdist
        path: dist/*.tar.gz
  build_wheels:
    runs-on: [self-hosted, linux, x64]
    steps:
    - uses: actions/checkout@v4
    - name: Checkout submodules
      run: |
        git submodule update --init --recursive
          # Used to host cibuildwheel
    - uses: astral-sh/setup-uv@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install cibuildwheel
      run: python -m pip install cibuildwheel==2.23.2

    - name: Build wheels
      run: python -m cibuildwheel --output-dir wheelhouse
      env:
        CIBW_SKIP: pp* *-musllinux*
        CIBW_ARCHS: x86_64
    - uses: actions/upload-artifact@v4
      with:
        name: cibw-wheels-ubuntu-latest
        path: wheelhouse/*.whl
  upload_all:
    name: Upload if release
    needs: [build_wheels, build_sdist]
    runs-on: [self-hosted, linux, x64]
    # if: github.event_name == 'release' && github.event.action == 'published'
    environment:
     name: pypi
     url: https://pypi.org/p/touchlab_comm_py
    permissions:
      id-token: write
      attestations: write

    steps:
    - uses: actions/setup-python@v5
      with:
        python-version: "3.x"

    - uses: actions/download-artifact@v4
      with:
        pattern: cibw-*
        merge-multiple: true
        path: dist

    # - name: Generate artifact attestation for sdist and wheels
    #   uses: actions/attest-build-provenance@v1
    #   with:
    #     subject-path: "dist/*"
    - name: Publish package distributions to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      # - name: Create a GitHub release
      #   uses: ncipollo/release-action@v1
      #   with:
      #     artifacts: ${{ github.workspace }}/touchlab_comm_py.zip
      #     allowUpdates: true

