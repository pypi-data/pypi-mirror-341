{"version":3,"file":"c.B-et3y2-.js","sources":["../../../../src/util/console-color.ts","../../../../src/components/remote-process.ts","../../../../src/util/basename.ts","../../../../src/components/process-dialog.ts"],"sourcesContent":["interface ConsoleState {\n  bold: boolean;\n  italic: boolean;\n  underline: boolean;\n  strikethrough: boolean;\n  foregroundColor: string | null;\n  backgroundColor: string | null;\n  carriageReturn: boolean;\n  secret: boolean;\n}\n\nexport class ColoredConsole {\n  public state: ConsoleState = {\n    bold: false,\n    italic: false,\n    underline: false,\n    strikethrough: false,\n    foregroundColor: null,\n    backgroundColor: null,\n    carriageReturn: false,\n    secret: false,\n  };\n\n  constructor(public targetElement: HTMLElement) {}\n\n  logs(): string {\n    return this.targetElement.innerText;\n  }\n\n  addLine(line: string) {\n    const re = /(?:\\x1b|\\\\033)(?:\\[(.*?)[@-~]|\\].*?(?:\\x07|\\x07\\\\))/g;\n    let i = 0;\n\n    if (this.state.carriageReturn) {\n      if (line !== \"\\n\") {\n        // don't remove if \\r\\n\n        this.targetElement.removeChild(this.targetElement.lastChild!);\n      }\n      this.state.carriageReturn = false;\n    }\n\n    if (line.includes(\"\\r\")) {\n      this.state.carriageReturn = true;\n    }\n\n    const lineSpan = document.createElement(\"span\");\n    lineSpan.classList.add(\"line\");\n    this.targetElement.appendChild(lineSpan);\n\n    const addSpan = (content: string) => {\n      if (content === \"\") return;\n\n      const span = document.createElement(\"span\");\n      if (this.state.bold) span.classList.add(\"log-bold\");\n      if (this.state.italic) span.classList.add(\"log-italic\");\n      if (this.state.underline) span.classList.add(\"log-underline\");\n      if (this.state.strikethrough) span.classList.add(\"log-strikethrough\");\n      if (this.state.secret) span.classList.add(\"log-secret\");\n      if (this.state.foregroundColor !== null)\n        span.classList.add(`log-fg-${this.state.foregroundColor}`);\n      if (this.state.backgroundColor !== null)\n        span.classList.add(`log-bg-${this.state.backgroundColor}`);\n      span.appendChild(document.createTextNode(content));\n      lineSpan.appendChild(span);\n\n      if (this.state.secret) {\n        const redacted = document.createElement(\"span\");\n        redacted.classList.add(\"log-secret-redacted\");\n        redacted.appendChild(document.createTextNode(\"[redacted]\"));\n        lineSpan.appendChild(redacted);\n      }\n    };\n\n    while (true) {\n      const match = re.exec(line);\n      if (match === null) break;\n\n      const j = match.index;\n      addSpan(line.substring(i, j));\n      i = j + match[0].length;\n\n      if (match[1] === undefined) continue;\n\n      for (const colorCode of match[1].split(\";\")) {\n        switch (parseInt(colorCode)) {\n          case 0:\n            // reset\n            this.state.bold = false;\n            this.state.italic = false;\n            this.state.underline = false;\n            this.state.strikethrough = false;\n            this.state.foregroundColor = null;\n            this.state.backgroundColor = null;\n            this.state.secret = false;\n            break;\n          case 1:\n            this.state.bold = true;\n            break;\n          case 3:\n            this.state.italic = true;\n            break;\n          case 4:\n            this.state.underline = true;\n            break;\n          case 5:\n            this.state.secret = true;\n            break;\n          case 6:\n            this.state.secret = false;\n            break;\n          case 9:\n            this.state.strikethrough = true;\n            break;\n          case 22:\n            this.state.bold = false;\n            break;\n          case 23:\n            this.state.italic = false;\n            break;\n          case 24:\n            this.state.underline = false;\n            break;\n          case 29:\n            this.state.strikethrough = false;\n            break;\n          case 30:\n            this.state.foregroundColor = \"black\";\n            break;\n          case 31:\n            this.state.foregroundColor = \"red\";\n            break;\n          case 32:\n            this.state.foregroundColor = \"green\";\n            break;\n          case 33:\n            this.state.foregroundColor = \"yellow\";\n            break;\n          case 34:\n            this.state.foregroundColor = \"blue\";\n            break;\n          case 35:\n            this.state.foregroundColor = \"magenta\";\n            break;\n          case 36:\n            this.state.foregroundColor = \"cyan\";\n            break;\n          case 37:\n            this.state.foregroundColor = \"white\";\n            break;\n          case 39:\n            this.state.foregroundColor = null;\n            break;\n          case 41:\n            this.state.backgroundColor = \"red\";\n            break;\n          case 42:\n            this.state.backgroundColor = \"green\";\n            break;\n          case 43:\n            this.state.backgroundColor = \"yellow\";\n            break;\n          case 44:\n            this.state.backgroundColor = \"blue\";\n            break;\n          case 45:\n            this.state.backgroundColor = \"magenta\";\n            break;\n          case 46:\n            this.state.backgroundColor = \"cyan\";\n            break;\n          case 47:\n            this.state.backgroundColor = \"white\";\n            break;\n          case 40:\n          case 49:\n            this.state.backgroundColor = null;\n            break;\n        }\n      }\n    }\n    const atBottom =\n      this.targetElement.scrollTop >\n      this.targetElement.scrollHeight - this.targetElement.offsetHeight - 50;\n\n    addSpan(line.substring(i));\n\n    // Keep scroll at bottom\n    if (atBottom) {\n      this.targetElement.scrollTop = this.targetElement.scrollHeight;\n    }\n  }\n}\n\nexport const coloredConsoleStyles = `\n  .log {\n    flex: 1;\n    background-color: #1c1c1c;\n    font-family: \"SFMono-Regular\", Consolas, \"Liberation Mono\", Menlo, Courier,\n      monospace;\n    font-size: 12px;\n    padding: 16px;\n    overflow: auto;\n    line-height: 1.45;\n    border-radius: 3px;\n    white-space: pre-wrap;\n    overflow-wrap: break-word;\n    color: #ddd;\n  }\n\n  .log-bold {\n    font-weight: bold;\n  }\n  .log-italic {\n    font-style: italic;\n  }\n  .log-underline {\n    text-decoration: underline;\n  }\n  .log-strikethrough {\n    text-decoration: line-through;\n  }\n  .log-underline.log-strikethrough {\n    text-decoration: underline line-through;\n  }\n  .log-secret {\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    -ms-user-select: none;\n    user-select: none;\n  }\n  .log-secret-redacted {\n    opacity: 0;\n    width: 1px;\n    font-size: 1px;\n  }\n  .log-fg-black {\n    color: rgb(128, 128, 128);\n  }\n  .log-fg-red {\n    color: rgb(255, 0, 0);\n  }\n  .log-fg-green {\n    color: rgb(0, 255, 0);\n  }\n  .log-fg-yellow {\n    color: rgb(255, 255, 0);\n  }\n  .log-fg-blue {\n    color: rgb(0, 0, 255);\n  }\n  .log-fg-magenta {\n    color: rgb(255, 0, 255);\n  }\n  .log-fg-cyan {\n    color: rgb(0, 255, 255);\n  }\n  .log-fg-white {\n    color: rgb(187, 187, 187);\n  }\n  .log-bg-black {\n    background-color: rgb(0, 0, 0);\n  }\n  .log-bg-red {\n    background-color: rgb(255, 0, 0);\n  }\n  .log-bg-green {\n    background-color: rgb(0, 255, 0);\n  }\n  .log-bg-yellow {\n    background-color: rgb(255, 255, 0);\n  }\n  .log-bg-blue {\n    background-color: rgb(0, 0, 255);\n  }\n  .log-bg-magenta {\n    background-color: rgb(255, 0, 255);\n  }\n  .log-bg-cyan {\n    background-color: rgb(0, 255, 255);\n  }\n  .log-bg-white {\n    background-color: rgb(255, 255, 255);\n  }\n`;\n","import { customElement } from \"lit/decorators.js\";\nimport { StreamError, streamLogs } from \"../api\";\nimport { ColoredConsole, coloredConsoleStyles } from \"../util/console-color\";\nimport { fireEvent } from \"../util/fire-event\";\n\n@customElement(\"esphome-remote-process\")\nclass ESPHomeRemoteProcess extends HTMLElement {\n  public type!: \"validate\" | \"logs\" | \"upload\" | \"clean-mqtt\" | \"clean\";\n  public spawnParams!: Record<string, any>;\n\n  private _coloredConsole?: ColoredConsole;\n  private _abortController?: AbortController;\n\n  public logs(): string {\n    return this._coloredConsole?.logs() || \"\";\n  }\n\n  public connectedCallback() {\n    if (this._coloredConsole) {\n      return;\n    }\n    const shadowRoot = this.attachShadow({ mode: \"open\" });\n\n    shadowRoot.innerHTML = `\n      <style>\n        :host {\n          display: flex;\n        }\n        ${coloredConsoleStyles}\n      </style>\n      <div class=\"log\"></div>\n    `;\n\n    const coloredConsole = new ColoredConsole(shadowRoot.querySelector(\"div\")!);\n    this._coloredConsole = coloredConsole;\n    this._abortController = new AbortController();\n\n    streamLogs(\n      this.type,\n      this.spawnParams,\n      (line) => {\n        coloredConsole.addLine(line);\n      },\n      this._abortController,\n    ).then(\n      () => {\n        fireEvent(this, \"process-done\", 0);\n      },\n      (error: StreamError) => {\n        fireEvent(this, \"process-done\", error.code);\n      },\n    );\n  }\n\n  public disconnectedCallback() {\n    if (this._abortController) {\n      this._abortController.abort();\n      this._abortController = undefined;\n    }\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"esphome-remote-process\": ESPHomeRemoteProcess;\n  }\n}\n","export const basename = (path: string) => path.replace(/\\.[^/.]+$/, \"\");\n","import { LitElement, html, css } from \"lit\";\nimport { customElement, property, state } from \"lit/decorators.js\";\nimport \"@material/mwc-dialog\";\nimport \"@material/mwc-button\";\nimport \"../components/remote-process\";\nimport { fireEvent } from \"../util/fire-event\";\nimport { esphomeDialogStyles } from \"../styles\";\nimport { textDownload } from \"../util/file-download\";\nimport { basename } from \"../util/basename\";\n\n@customElement(\"esphome-process-dialog\")\nexport class ESPHomeProcessDialog extends LitElement {\n  @property() public heading!: string;\n  @property() public spawnParams?: Record<string, any>;\n  @property() public type!: string;\n\n  @property({ type: Boolean, attribute: \"always-show-close\" })\n  public alwaysShowClose = false;\n\n  @state() private _result?: number;\n\n  protected render() {\n    return html`\n      <mwc-dialog\n        open\n        heading=${this.heading}\n        scrimClickAction\n        @closed=${this._handleClose}\n      >\n        <esphome-remote-process\n          .type=${this.type}\n          .spawnParams=${this.spawnParams}\n          @process-done=${this._handleProcessDone}\n        ></esphome-remote-process>\n\n        <mwc-button\n          slot=\"secondaryAction\"\n          label=\"Download Logs\"\n          @click=${this._downloadLogs}\n        ></mwc-button>\n\n        <slot name=\"secondaryAction\" slot=\"secondaryAction\"></slot>\n\n        <mwc-button\n          slot=\"primaryAction\"\n          dialogAction=\"close\"\n          .label=${this._result === undefined && !this.alwaysShowClose\n            ? \"Stop\"\n            : \"Close\"}\n        ></mwc-button>\n      </mwc-dialog>\n    `;\n  }\n\n  private _handleProcessDone(ev: { detail: number }) {\n    this._result = ev.detail;\n  }\n\n  private _handleClose() {\n    fireEvent(this, \"closed\");\n  }\n\n  private _downloadLogs() {\n    let filename = \"logs\";\n    if (this.spawnParams?.configuration) {\n      // Append filename without extension\n      filename += `_${basename(this.spawnParams.configuration)}`;\n    }\n    filename += `_${this.type}.txt`;\n\n    textDownload(\n      this.shadowRoot!.querySelector(\"esphome-remote-process\")!.logs(),\n      filename,\n    );\n  }\n\n  static styles = [\n    esphomeDialogStyles,\n    css`\n      :host {\n        --height-header-footer-padding: 152px;\n      }\n      mwc-dialog {\n        --mdc-dialog-min-width: 95vw;\n        --mdc-dialog-max-width: 95vw;\n      }\n\n      esphome-remote-process {\n        height: calc(90vh - var(--height-header-footer-padding));\n      }\n\n      @media only screen and (max-width: 450px) {\n        esphome-remote-process {\n          height: calc(\n            90vh - var(--height-header-footer-padding) - env(\n                safe-area-inset-bottom\n              )\n          );\n          margin-left: -24px;\n          margin-right: -24px;\n        }\n      }\n    `,\n  ];\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"esphome-process-dialog\": ESPHomeProcessDialog;\n  }\n}\n"],"names":["ColoredConsole","constructor","targetElement","this","state","bold","italic","underline","strikethrough","foregroundColor","backgroundColor","carriageReturn","secret","logs","innerText","addLine","line","re","i","removeChild","lastChild","includes","lineSpan","document","createElement","classList","add","appendChild","addSpan","content","span","createTextNode","redacted","match","exec","j","index","substring","length","undefined","colorCode","split","parseInt","atBottom","scrollTop","scrollHeight","offsetHeight","coloredConsoleStyles","ESPHomeRemoteProcess","HTMLElement","_a","_coloredConsole","connectedCallback","shadowRoot","attachShadow","mode","innerHTML","coloredConsole","querySelector","_abortController","AbortController","streamLogs","type","spawnParams","then","fireEvent","error","code","disconnectedCallback","abort","__decorate","customElement","basename","path","replace","ESPHomeProcessDialog","LitElement","alwaysShowClose","render","html","heading","_handleClose","_handleProcessDone","_downloadLogs","_result","ev","detail","filename","configuration","textDownload","styles","esphomeDialogStyles","css","property","prototype","Boolean","attribute"],"mappings":"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"}