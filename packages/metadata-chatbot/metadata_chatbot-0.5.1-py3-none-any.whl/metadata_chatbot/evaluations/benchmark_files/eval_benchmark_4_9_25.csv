input_question,output_answer,output_answer,output_mongodb_query,output_python
Identify the number of assets where acquisition.experimenter_full_name exist as strings instead of a list of strings,There are 3984 records where acquisition.experimenter_full_name exist as strings instead of a list of strings,,,
"for mouse 721291 can you make a table of sessions, date, and session_type?","Sessions for Mouse 721291
 Session, Date, Session Type
1,2024-04-26,TRAINING_3_images_A_10uL_reward
2,2024-04-29,TRAINING_3_images_A_10uL_reward 
3,2024-04-30,TRAINING_3_images_A_10uL_reward 
 The table shows all three sessions recorded for mouse 721291, with dates extracted from the session_start_time field and the consistent session type across all sessions",,"{""filter"":{""subject.subject_id"":""721291""},""projection"":{""name"":1,""session.session_type"":1,""session.session_start_time"":1,""_id"":0}}",
Tell me about mouse 747107,"Mouse 747107 is a female Mus musculus with the genotype Slc32a1-IRES-Cre/wt;Oi1(TIT2L-jGCaMP8s-WPRE-ICL-IRES-tTA2)/wt. The mouse was housed in cage 8272325 in room 221 and was sourced from the Allen Institute. 

The mouse underwent planar optical physiology (pophys) experiments using a mesoscope setup. The imaging was performed with a 920nm wavelength laser at various depths in the visual cortex (VISp). Multiple field of views (FOVs) were recorded at different imaging depths ranging from 68 to 260 micrometers, with a frame rate of 9.48 Hz. 

The experimental setup included eye and face cameras to monitor the mouse's behavior, and the mouse was placed on a running disk platform manufactured by the Allen Institute for Neural Dynamics, which had a radius of 8.255 centimeters.",,"{""subject.subject_id"": ""747107""}",
How many records use the session.data_streams.slap_fovs field,there are 5488 records with session.data_streams.slap_fovs,,"{""agg_pipeline"":[{""$match"":{""session.data_streams.slap_fovs"":{""$exists"":true}}},{""$count"":""count""}]}",
can you tell me how many sessions exist for 775745,There are 50 sessions for subject 775745,,"filter = {""subject.subject_id"": ""775745""}
projection = {""name"": 1, ""_id"": 1}","import json
from aind_data_access_api.document_db import MetadataDbClient

API_GATEWAY_HOST = ""api.allenneuraldynamics.org""
DATABASE = ""metadata_index""
COLLECTION = ""data_assets""

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

filter = {""subject.subject_id"": ""775745""}
projection = {""name"": 1, ""_id"": 1}

records = docdb_api_client.retrieve_docdb_records(
    filter_query=filter,
    projection=projection
)

# Count the number of sessions
num_sessions = len(records)
print(f""Total number of sessions for subject 775745: {num_sessions}"")

# Optional: Print session names
print(""\nSession Names:"")
for record in records:
    print(record['name'])"
Find how many experimental sessions conducted by experimenter Marton Rozsa in 2022.,86 sessions were conducted by Marton Rozsa,,"{""agg_pipeline"":[{""$match"":{""$or"":[{""acquisition.experimenter_full_name"":""Marton Rozsa"",""acquisition.session_start_time"":{""$regex"":""2022-"",""$options"":""i""}},{""session.experimenter_full_name"":{""$in"":[""Marton Rozsa""]},""session.session_start_time"":{""$regex"":""2022-"",""$options"":""i""}}]}},{""$count"":""total_sessions""}]}",
Generate code to find experiments where the animal weight decreased by more than 10% between consecutive procedures.,"I'll create a MongoDB aggregation pipeline to find all unique subject IDs where the animal weight decreased by more than 10% between consecutive procedures. Here's the Python code that implements this:

import json
from aind_data_access_api.document_db import MetadataDbClient

API_GATEWAY_HOST = ""api.allenneuraldynamics.org""
DATABASE = ""metadata_index""
COLLECTION = ""data_assets""

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

agg_pipeline = [
    # Match records with subject procedures
    {'$match': {'procedures.subject_procedures': {'$exists': True, '$ne': []}}},

    # Project relevant fields
    {'$project': {
        '_id': 1, 
        'subject_id': '$procedures.subject_id', 
        'subject_procedures': '$procedures.subject_procedures'
    }},

    # Unwind subject procedures
    {'$unwind': '$subject_procedures'},

    # Match procedures with valid weight measurements
    {'$match': {
        'subject_procedures.animal_weight_prior': {'$exists': True, '$ne': None},
        'subject_procedures.animal_weight_post': {'$exists': True, '$ne': None}
    }},

    # Project and convert weights to numeric
    {'$project': {
        '_id': 1, 
        'subject_id': 1, 
        'procedure_type': '$subject_procedures.procedure_type',
        'start_date': '$subject_procedures.start_date',
        'weight_prior': {'$toDouble': '$subject_procedures.animal_weight_prior'},
        'weight_post': {'$toDouble': '$subject_procedures.animal_weight_post'},
        'weight_unit': '$subject_procedures.weight_unit'
    }},

    # Remove null weight entries
    {'$match': {
        'weight_prior': {'$ne': None}, 
        'weight_post': {'$ne': None}
    }},

    # Calculate percentage weight change
    {'$project': {
        '_id': 1, 
        'subject_id': 1, 
        'procedure_type': 1, 
        'start_date': 1,
        'weight_prior': 1, 
        'weight_post': 1, 
        'weight_unit': 1, 
        'weight_change_percent': {'$multiply': [
            {'$divide': [
                {'$subtract': ['$weight_post', '$weight_prior']}, 
                '$weight_prior'
            ]}, 
            100
        ]}
    }},

    # Filter for weight decrease > 10%
    {'$match': {'weight_change_percent': {'$lt': -10}}},

    # Group by subject_id to get unique subjects
    {'$group': {'_id': '$subject_id'}},

    # Format output
    {'$project': {'_id': 0, 'subject_id': '$_id'}},

    # Sort results
    {'$sort': {'subject_id': 1}}
]

# Execute the aggregation
result = docdb_api_client.aggregate_docdb_records(
    pipeline=agg_pipeline
)

# Print results
print(""Unique Subject IDs with Weight Decrease > 10%:"")
for record in result:
    print(f""Subject ID: {record['subject_id']}"")

# Print total count
print(f""\nTotal number of unique subjects: {len(result)}"")

The query found 7 unique subject IDs where the animal weight decreased by more than 10% between procedures:

Subject ID: 661797
Subject ID: 671413
Subject ID: 697930
Subject ID: 730049
Subject ID: 734159
Subject ID: 741752
Subject ID: 750101
This code:

Matches records with subject procedures
Projects the relevant fields
Unwinds the subject procedures array
Filters for procedures with valid weight measurements
Converts string weights to numeric values
Calculates the weight change percentage
Filters",,"{""agg_pipeline"":[{""$match"":{""procedures.subject_procedures"":{""$exists"":true,""$ne"":[]}}},{""$project"":{""_id"":1,""subject_id"":""$procedures.subject_id"",""subject_procedures"":""$procedures.subject_procedures""}},{""$unwind"":""$subject_procedures""},{""$match"":{""subject_procedures.animal_weight_prior"":{""$exists"":true,""$ne"":null},""subject_procedures.animal_weight_post"":{""$exists"":true,""$ne"":null}}},{""$project"":{""_id"":1,""subject_id"":1,""procedure_type"":""$subject_procedures.procedure_type"",""start_date"":""$subject_procedures.start_date"",""weight_prior"":{""$toDouble"":""$subject_procedures.animal_weight_prior""},""weight_post"":{""$toDouble"":""$subject_procedures.animal_weight_post""},""weight_unit"":""$subject_procedures.weight_unit""}},{""$match"":{""weight_prior"":{""$ne"":null},""weight_post"":{""$ne"":null}}},{""$project"":{""_id"":1,""subject_id"":1,""procedure_type"":1,""start_date"":1,""weight_prior"":1,""weight_post"":1,""weight_unit"":1,""weight_change_percent"":{""$multiply"":[{""$divide"":[{""$subtract"":[""$weight_post"",""$weight_prior""]},""$weight_prior""]},100]}}},{""$match"":{""weight_change_percent"":{""$lt"":-10}}},{""$group"":{""_id"":""$subject_id""}},{""$project"":{""_id"":0,""subject_id"":""$_id""}},{""$sort"":{""subject_id"":1}}]}","import json
from aind_data_access_api.document_db import MetadataDbClient


docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

agg_pipeline = [
    # Match records with subject procedures
    {'$match': {'procedures.subject_procedures': {'$exists': True, '$ne': []}}},

    # Project relevant fields
    {'$project': {
        '_id': 1, 
        'subject_id': '$procedures.subject_id', 
        'subject_procedures': '$procedures.subject_procedures'
    }},

    # Unwind subject procedures
    {'$unwind': '$subject_procedures'},

    # Match procedures with valid weight measurements
    {'$match': {
        'subject_procedures.animal_weight_prior': {'$exists': True, '$ne': None},
        'subject_procedures.animal_weight_post': {'$exists': True, '$ne': None}
    }},

    # Project and convert weights to numeric
    {'$project': {
        '_id': 1, 
        'subject_id': 1, 
        'procedure_type': '$subject_procedures.procedure_type',
        'start_date': '$subject_procedures.start_date',
        'weight_prior': {'$toDouble': '$subject_procedures.animal_weight_prior'},
        'weight_post': {'$toDouble': '$subject_procedures.animal_weight_post'},
        'weight_unit': '$subject_procedures.weight_unit'
    }},

    # Remove null weight entries
    {'$match': {
        'weight_prior': {'$ne': None}, 
        'weight_post': {'$ne': None}
    }},

    # Calculate percentage weight change
    {'$project': {
        '_id': 1, 
        'subject_id': 1, 
        'procedure_type': 1, 
        'start_date': 1,
        'weight_prior': 1, 
        'weight_post': 1, 
        'weight_unit': 1, 
        'weight_change_percent': {'$multiply': [
            {'$divide': [
                {'$subtract': ['$weight_post', '$weight_prior']}, 
                '$weight_prior'
            ]}, 
            100
        ]}
    }},

    # Filter for weight decrease > 10%
    {'$match': {'weight_change_percent': {'$lt': -10}}},

    # Group by subject_id to get unique subjects
    {'$group': {'_id': '$subject_id'}},

    # Format output
    {'$project': {'_id': 0, 'subject_id': '$_id'}},

    # Sort results
    {'$sort': {'subject_id': 1}}
]

# Execute the aggregation
result = docdb_api_client.aggregate_docdb_records(
    pipeline=agg_pipeline
)

# Print results
print(""Unique Subject IDs with Weight Decrease > 10%:"")
for record in result:
    print(f""Subject ID: {record['subject_id']}"")

# Print total count
print(f""\nTotal number of unique subjects: {len(result)}"")"
What are the injections for SmartSPIM_675387_2023-05-23_23-05-56?,"
                    Based on the provided context, the injections for SmartSPIM_675387_2023-05-23_23-05-56 are:
                    1. AAVrg-Syn-H2B-Turquoise virus with titer 48000000000000 gc/mL, injected at coordinates ML 1.0 mm, AP 1.2 mm, depth 0.8 mm from Bregma, with injection volume 50.0 nanoliters, targeting the Isocortex in the right hemisphere.
                    2. AAVrg-Syn-H2B-tdTomato virus with titer 51000000000000 gc/mL, injected at coordinates ML 1.4 mm, AP 1.2 mm, depth 0.8 mm from Bregma, with injection volume 50.0 nanoliters, targeting the Isocortex in the right hemisphere.
                    Both injections were performed using the Nanoject injection procedure with a 5.0 minute recovery time.
                    ",,"{""filter"":{""name"":""SmartSPIM_675387_2023-05-23_23-05-56""},""projection"":{""procedures.subject_procedures"":1}}","import json

from aind_data_access_api.document_db import MetadataDbClient

API_GATEWAY_HOST = ""api.allenneuraldynamics.org""
DATABASE = ""metadata_index""
COLLECTION = ""data_assets""

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

filter = {""name"": ""SmartSPIM_675387_2023-05-23_23-05-56""}
projection = {
    ""procedures.subject_procedures"":1
}

records = docdb_api_client.retrieve_docdb_records(
    filter_query=filter,
    projection=projection,
)

print(records)"
what are the modalities of the assets for the 'U19 Thalamus in the Middle' project?,"""Selective plane illumination microscopy"", ""Extracellular electrophysiology"", ""Behavior videos"", ""Behavior""",,"agg_pipeline = [
    {'$match': {'data_description.project_name': {'$regex': 'Thalamus in the middle', '$options': 'i'}}},
    {'$unwind': {'path': '$data_description.modality', 'preserveNullAndEmptyArrays': True}},
    {'$group': {'_id': '$data_description.modality.name', 'count': {'$sum': 1}}},
    {'$sort': {'count': -1}}
]","import json
from collections import Counter
from datetime import datetime

from aind_data_access_api.document_db import MetadataDbClient


docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

agg_pipeline = [
    {'$match': {'data_description.project_name': {'$regex': 'Thalamus in the middle', '$options': 'i'}}},
    {'$unwind': {'path': '$data_description.modality', 'preserveNullAndEmptyArrays': True}},
    {'$group': {'_id': '$data_description.modality.name', 'count': {'$sum': 1}}},
    {'$sort': {'count': -1}}
]

result = docdb_api_client.aggregate_docdb_records(
    pipeline=agg_pipeline
)
print(json.dumps(result, indent=3))"
What is Acquisition?,An Acquisition in AIND metadata refers to the acquisition of a data asset specifically for in vitro imaging modalities like light sheet and confocal microscopy. This is distinct from a 'session' which is used in reference to physiology and behavior data collection.,,,
How do I create a subject file?,"Based on the provided information, there are two ways to create a subject file:Using the GUI: You can use the metadata entry web application at https://metadata-entry.allenneuraldynamics.org/ Using Python code: You'll need to use the aind-data-schema library. ",,,
Do I need to create a new rig/instrument file for each data asset?,"Ideally no. The rig/instrument file should be relatively stable and hopefully won’t change much from one day to the next, so you can reuse the same file for multiple data assets. However, when the devices in a rig do change, the rig/ instrument file must be updated. For instance, replacing a broken Neuropixels probe requires an updated file, as does adding or moving a camera to a rig. The rig_id and the date_of_modification should make it clear when the file was last updated.",,,
How do I use the Calibration field?,"This is to track any device calibrations that are performed, such as gamma correction for monitors, reward valve delivery calibration, laser power calibration, etc. For calibrations that are done less frequently (e.g. gamma correction) this can be documented in the Rig schema. For calibrations that are done frequently, they can do documented in the Session schema. Both places use the same class. This class identifies which device is calibrated (using the device’s name), a description of the calibration (e.g. “Laser power calibration”), and then an input dictionary and an output dictionary. You can use this as makes most sense for your needs, but we envision the input dictionary having input values (say laser power percentage settings) and the output dictionary having output values (say the measured wattage out of the laser). You define the key and provide a list of the values. We recommed that you use the same dictionary structures when you do the same calibrations (when possible).",,,
How do I create a processing file?,"You can create a procedure file using our metadata entry web application. The internal data transfer service creates a processing.json file when it performs data compression or other preprocessing prior to upload. When derived data assets are created, they should have a processing.json files that has appended new processing steps to that original file. This needs to be done using python code that imports aind-data-schema.",,,
Assess the completeness of experimental metadata for subject_id '675387,"Metadata Completeness Assessment for Subject ID 675387
Based on the provided data, I've analyzed the completeness of experimental metadata across all assets for subject_id '675387'.

Subject information: Complete (subject_id, species, sex, date of birth, genotype)
Subject procedures: Complete (surgery dates, experimenter names, procedure types)
Specimen procedures: Complete (fixation, delipidation, refractive index matching)
Acquisition data: Complete (session times, instrument ID, imaging parameters)
Instrument details: Complete (manufacturer, location, components)
Missing some tars_identifiers in virus information
Missing some calibration data for the instrument
Missing active objectives in acquisition data
Missing some reference values for injection coordinates
Missing some specimen housing information
Quality Control:
QC evaluations present for SPIM modality
Cell detection evaluations for channels 445 and 561 marked as ""Fail"" in thalamus region

The experimental metadata for subject_id '675387' is largely complete with comprehensive documentation of procedures, acquisition parameters, and instrument details, though some optional fields could be improved for better traceability.",,,
what was the average age of animals injected with CVS N2cdG-H2B-tdTomato at time of perfusion use mongodb,"The analysis shows that the animals were perfused at the following ages:

Subject ID	Date of Birth	Perfusion Date	Age at Perfusion (days)
693977	2023-07-16	2023-09-12	58
693979	2023-07-16	2023-09-14	60
693980	2023-07-16	2023-09-13	59
698927	2023-07-18	2023-09-05	49
698928	2023-07-18	2023-09-05	49
Average age at perfusion: 55 days (approximately 7.9 weeks)

All animals were born in mid-July 2023 and perfused in early-to-mid September 2023, after receiving CVS N2cdG-H2B-tdTomato injections in late August 2023.",,,
"For subject_id '675387', identify which brain structures have been imaged across multiple sessions and which imaging modalities were used for each.","Based on the provided context, I can identify the brain structures that have been imaged across multiple sessions for subject_id '675387' and the imaging modalities used.

The subject had multiple imaging sessions using a SmartSPIM platform (Selective Plane Illumination Microscopy or SPIM). The imaging focused on several brain structures, with specific attention to the Thalamus as noted in the quality control evaluations.

Brain structures imaged across multiple sessions:

Thalamus (specifically mentioned in quality control evaluations)
Isocortex (targeted during injection procedures)
Imaging modalities used for each structure:

For Thalamus:

Selective Plane Illumination Microscopy (SPIM) using three different laser wavelengths:
445 nm laser (30.0 mW power) with 469 nm emission filter
561 nm laser (25.0 mW power) with 593 nm emission filter
639 nm laser (90.0 mW power) with 660 nm emission filter
For Isocortex:

Same SPIM modalities as above with the three laser wavelengths
The imaging was performed using a SmartSPIM instrument (SmartSPIM1-1 and SmartSPIM1-2) with multiple imaging sessions occurring on May 23-24, 2023, with additional processing on June 1, 2023. Quality control evaluations noted that cell detection in both the 445 nm and 561 nm channels failed specifically in the Thalamus region.",,,
In 2024 which month had the most number of metadata assets collected?,"July (month 7) had the most metadata assets collected in 2024 with 9,360 assets.",,"{""agg_pipeline"":[{""$match"":{""created"":{""$gte"":""2024-01-01T00:00:00.000Z"",""$lt"":""2025-01-01T00:00:00.000Z""}}},{""$project"":{""month"":{""$month"":{""$toDate"":""$created""}}}},{""$group"":{""_id"":""$month"",""count"":{""$sum"":1}}},{""$sort"":{""count"":-1}}]}",
"How many injections were performed across all animals in the thalamus in the middle project using the following coordinate: AP: 2.8, ML: 0.2, DV: 0.6?",There are 20 injections with that coordinate.,,"{""agg_pipeline"":[{""$match"":{""data_description.project_name"":""Thalamus in the middle"",""procedures.subject_procedures"":{""$elemMatch"":{""procedures"":{""$elemMatch"":{""injection_coordinate_ap"":""2.8"",""injection_coordinate_ml"":""0.2"",""injection_coordinate_depth"":""0.6""}}}}}},{""$project"":{""_id"":1,""name"":1,""data_description.project_name"":1,""procedures.subject_procedures.procedures"":{""$filter"":{""input"":{""$reduce"":{""input"":""$procedures.subject_procedures"",""initialValue"":[],""in"":{""$concatArrays"":[""$$value"",{""$filter"":{""input"":""$$this.procedures"",""as"":""proc"",""cond"":{""$and"":[{""$eq"":[""$$proc.injection_coordinate_ap"",""2.8""]},{""$eq"":[""$$proc.injection_coordinate_ml"",""0.2""]},{""$eq"":[""$$proc.injection_coordinate_depth"",""0.6""]}]}}}]}}},""as"":""proc"",""cond"":{""$eq"":[""$$proc.injection_coordinate_ap"",""2.8""]}}}}},{""$count"":""total_injections""}]}",
Provide the mongodb query needed to find the channels used in the SmartSPIM session from subject 699834 on oct 31st 2023,"Based on the MongoDB query executed and the results returned, I can provide you with the MongoDB query needed to find the channels used in the SmartSPIM session from subject 699834 on October 31st, 2023. Here's the explanation of the query and its results: MongoDB Query:```javascript[{$match:{'subject.subject_id': '699834','data_description.creation_time': { $gte: '2023-10-31T00:00:00Z', $lt: '2023-11-01T00:00:00Z'},'data_description.modality.name': 'Selective plane illumination microscopy'}},{$project: {name: 1, channels: '$acquisition.tiles.channel.channel_name'}},{$unwind: '$channels'},{$group: { _id: '$name', unique_channels: {$addToSet: '$channels'}}}]``` Explanation of the query: 1. The `$match` stage filters the documents based on the subject ID, date range, and modality. 2. The `$project` stage selects the name field and extracts the channel names from the acquisition tiles. 3. The `$unwind` stage deconstructs the channels array. 4. The `$group` stage groups the results by the experiment name and collects unique channel names. Results: The query returned the following results: ```json [{'_id': 'SmartSPIM_699834_2023-10-31_16-31-46_stitched_2023-11-01_14-53-14', 'unique_channels': ['488', '561', '639']},{'_id': 'SmartSPIM_699834_2023-10-31_16-31-46','unique_channels': ['488', '561', '639']}]``` This shows that there were two entries for the SmartSPIM session on October 31st, 2023, for subject 699834: 1. The original session: 'SmartSPIM_699834_2023-10-31_16-31-46' 2. A stitched version: 'SmartSPIM_699834_2023-10-31_16-31-46_stitched_2023-11-01_14-53-14' Both entries used the same channels: 488 nm, 561 nm, and 639 nm. This query effectively retrieves the channels used in the SmartSPIM session for the specified subject and date.",,"[{$match:{'subject.subject_id': '699834','data_description.creation_time': { $gte: '2023-10-31T00:00:00Z', $lt: '2023-11-01T00:00:00Z'},'data_description.modality.name': 'Selective plane illumination microscopy'}},{$project: {name: 1, channels: '$acquisition.tiles.channel.channel_name'}},{$unwind: '$channels'},{$group: { _id: '$name', unique_channels: {$addToSet: '$channels'}}}]`",
 Are there any data assets within the patch foraging group that are missing metadata fields?,"Missing Metadata Fields in Patch Foraging Group:
acquisition: 907 records
instrument: 907 records
quality_control: 907 records
procedures: 372 records

Total Records with Missing Fields: 907",,"{""agg_pipeline"":[{""$match"":{""data_description.project_name"":{""$regex"":""patch foraging"",""$options"":""i""}}},{""$project"":{""_id"":1,""name"":1,""subject_id"":""$subject.subject_id"",""missing_fields"":{""$objectToArray"":{""subject"":{""$cond"":[{""$eq"":[""$subject"",null]},""missing"",""present""]},""data_description"":{""$cond"":[{""$eq"":[""$data_description"",null]},""missing"",""present""]},""procedures"":{""$cond"":[{""$eq"":[""$procedures"",null]},""missing"",""present""]},""session"":{""$cond"":[{""$eq"":[""$session"",null]},""missing"",""present""]},""rig"":{""$cond"":[{""$eq"":[""$rig"",null]},""missing"",""present""]},""processing"":{""$cond"":[{""$eq"":[""$processing"",null]},""missing"",""present""]},""acquisition"":{""$cond"":[{""$eq"":[""$acquisition"",null]},""missing"",""present""]},""instrument"":{""$cond"":[{""$eq"":[""$instrument"",null]},""missing"",""present""]},""quality_control"":{""$cond"":[{""$eq"":[""$quality_control"",null]},""missing"",""present""]}}}}},{""$match"":{""missing_fields.v"":""missing""}}]}",
Can you show me how to construct a mongodb query to identify a specific smartspim experiment?,"To construct a MongoDB query for a specific SmartSPIM experiment:

1. Use the `$match` stage to filter for SmartSPIM experiments.
2. Specify unique identifiers for the experiment you're looking for.
3. Use the `$project` stage to select the fields you want to retrieve.

Here's the example query broken down:

```javascript
[
  {
    ""$match"": {
      ""data_description.modality.name"": ""Selective plane illumination microscopy"",
      ""name"": ""SmartSPIM_662616_2023-04-14_15-11-04""
    }
  },
  {
    ""$project"": {
      ""_id"": 1,
      ""name"": 1,
      ""subject.subject_id"": 1,
      ""data_description.creation_time"": 1
    }
  }
]
```

Explanation:

1. `$match` stage:
   - Filters for experiments with the modality ""Selective plane illumination microscopy"" (which is what SmartSPIM uses).
   - Specifies the exact name of the experiment we're looking for.

2. `$project` stage:
   - Selects which fields to include in the output.
   - `1` means include the field, `0` would mean exclude it.
   - We're including the experiment ID, name, subject ID, and creation time.

To use this query for a different SmartSPIM experiment, you would modify the `name` field in the `$match` stage to the specific experiment you're looking for. For example:

```javascript
""name"": ""SmartSPIM_ANOTHER-ID_YYYY-MM-DD_HH-MM-SS""
```

You can also add more fields to the `$match` stage if you need to be more specific, or to the `$project` stage if you want to retrieve additional information.

This query, when executed, returned the following result:

```json
[
  {
    ""_id"": ""ff7b07e8-3187-4fcc-96c5-62ea1750340c"",
    ""data_description"": {
      ""creation_time"": ""2023-04-14T15:11:04-04:00""
    },
    ""name"": ""SmartSPIM_662616_2023-04-14_15-11-04"",
    ""subject"": {
      ""subject_id"": ""662616""
    }
  }
]
```

This shows that the query successfully identified the specific SmartSPIM experiment and returned the requested information.",," agg_pipeline:[{
    ""$match"": {
      ""data_description.modality.name"": ""Selective plane illumination microscopy"",
      ""name"": ""SmartSPIM_662616_2023-04-14_15-11-04""
    }
  },
  {
    ""$project"": {
      ""_id"": 1,
      ""name"": 1,
      ""subject.subject_id"": 1,
      ""data_description.creation_time"": 1
    }
  }]",
Show me how to create a mongodb query for the imaging channels present in a specific stitched data asset.,"import json
from aind_data_access_api.document_db import MetadataDbClient

API_GATEWAY_HOST = ""api.allenneuraldynamics.org""
DATABASE = ""metadata_index""
COLLECTION = ""data_assets""

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

# Filter for the specific SmartSPIM dataset
filter = {
    ""name"": # INSERT ASSET NAME
}

# Projection to extract only the channel information
projection = {
    ""acquisition.tiles.channel"": 1
}

# Retrieve records with limit 1
records = docdb_api_client.retrieve_docdb_records(
    filter_query=filter,
    projection=projection,
    limit=1
)

# Extract unique channels
unique_channels = set()
for record in records:
    for tile in record.get('acquisition', {}).get('tiles', []):
        channel = tile.get('channel', {})
        unique_channels.add(channel.get('channel_name'))

print(""Unique Channels:"")
print(json.dumps(list(unique_channels), indent=2))",,"filter = {
    ""name"": # INSERT ASSET NAME
}

# Projection to extract only the channel information
projection = {
    ""acquisition.tiles.channel"": 1
}",
"For subject 675387, create a timeline showing all procedures performed and identify any temporal overlaps between different experiment types.","Timeline of Procedures for Subject 675387
Subject Procedures
March 31, 2023: Surgery - Nanoject injections

Experimenter: Mathew Summers
IACUC Protocol: 2109
Two virus injections performed:
AAVrg-Syn-H2B-Turquoise into Isocortex (right hemisphere)
AAVrg-Syn-H2B-tdTomato into Isocortex (right hemisphere)
Anesthesia: Isoflurane (1.5%) for 45 minutes
April 28, 2023: Surgery - Perfusion

Output specimen ID: 675387
Specimen Procedures
April 21-24, 2023: SHIELD OFF Fixation

Experimenter: DT
April 24-25, 2023: SHIELD ON Fixation

Experimenter: DT
April 30-May 1, 2023: 24h Delipidation

Experimenter: DT
May 1-3, 2023: Active Delipidation

Experimenter: DT
May 3-4, 2023: 50% EasyIndex (Refractive index matching)

Experimenter: DT
May 4-5, 2023: 100% EasyIndex (Refractive index matching)

Experimenter: DT
May 8-10, 2023: SHIELD OFF Fixation (repeated)

Experimenter: DT
May 10-11, 2023: SHIELD ON Fixation (repeated)

Experimenter: DT
May 15-16, 2023: Passive Delipidation (repeated)

Experimenter: DT
May 16-18, 2023: Active Delipidation (repeated)

Experimenter: DT
May 18-19, 2023: 50% EasyIndex (repeated)

Experimenter: DT
May 19-20, 2023: 100% EasyIndex (repeated)

Experimenter: DT
May 23-24, 2023: SmartSPIM Imaging

Session start: May 23, 2023, 23:05:56
Session end: May 24, 2023, 04:10:10
Experimenter: John Rohde
Temporal Overlaps
No temporal overlaps between different experiment types were identified in the procedures.
All procedures were performed sequentially with clear start and end dates.",,"{""filter"":{""subject.subject_id"":""675387""},""projection"":{""name"":1,""procedures"":1,""data_description.modality"":1}}",
Give me the query used to identify 5 subject IDs that appear in 3 different assets with different modalities,"import json
from aind_data_access_api.document_db import MetadataDbClient

API_GATEWAY_HOST = ""api.allenneuraldynamics.org""
DATABASE = ""metadata_index""
COLLECTION = ""data_assets""

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

agg_pipeline = [
    {
        ""$match"": {
            ""data_description.modality"": {""$exists"": True, ""$ne"": []},
            ""subject.subject_id"": {""$exists"": True, ""$ne"": None}
        }
    },
    {
        ""$project"": {
            ""subject_id"": ""$subject.subject_id"",
            ""modalities"": ""$data_description.modality.name""
        }
    },
    {""$unwind"": ""$modalities""},
    {
        ""$group"": {
            ""_id"": {""subject_id"": ""$subject_id"", ""modality"": ""$modalities""}
        }
    },
    {
        ""$group"": {
            ""_id"": ""$_id.subject_id"",
            ""unique_modalities"": {""$addToSet"": ""$_id.modality""},
            ""modality_count"": {""$sum"": 1}
        }
    },
    {
        ""$match"": {
            ""modality_count"": {""$gte"": 3}
        }
    },
    {
        ""$project"": {
            ""_id"": 0,
            ""subject_id"": ""$_id"",
            ""unique_modalities"": 1,
            ""modality_count"": 1
        }
    },
    {""$sort"": {""modality_count"": -1}},
    {""$limit"": 5}
]

result = docdb_api_client.aggregate_docdb_records(pipeline=agg_pipeline)
print(json.dumps(result, indent=2))",,"agg_pipeline = [
    {
        ""$match"": {
            ""data_description.modality"": {""$exists"": True, ""$ne"": []},
            ""subject.subject_id"": {""$exists"": True, ""$ne"": None}
        }
    },
    {
        ""$project"": {
            ""subject_id"": ""$subject.subject_id"",
            ""modalities"": ""$data_description.modality.name""
        }
    },
    {""$unwind"": ""$modalities""},
    {
        ""$group"": {
            ""_id"": {""subject_id"": ""$subject_id"", ""modality"": ""$modalities""}
        }
    },
    {
        ""$group"": {
            ""_id"": ""$_id.subject_id"",
            ""unique_modalities"": {""$addToSet"": ""$_id.modality""},
            ""modality_count"": {""$sum"": 1}
        }
    },
    {
        ""$match"": {
            ""modality_count"": {""$gte"": 3}
        }
    },
    {
        ""$project"": {
            ""_id"": 0,
            ""subject_id"": ""$_id"",
            ""unique_modalities"": 1,
            ""modality_count"": 1
        }
    },
    {""$sort"": {""modality_count"": -1}},
    {""$limit"": 5}
]
","import json
from aind_data_access_api.document_db import MetadataDbClient

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

agg_pipeline = [
    {
        ""$match"": {
            ""data_description.modality"": {""$exists"": True, ""$ne"": []},
            ""subject.subject_id"": {""$exists"": True, ""$ne"": None}
        }
    },
    {
        ""$project"": {
            ""subject_id"": ""$subject.subject_id"",
            ""modalities"": ""$data_description.modality.name""
        }
    },
    {""$unwind"": ""$modalities""},
    {
        ""$group"": {
            ""_id"": {""subject_id"": ""$subject_id"", ""modality"": ""$modalities""}
        }
    },
    {
        ""$group"": {
            ""_id"": ""$_id.subject_id"",
            ""unique_modalities"": {""$addToSet"": ""$_id.modality""},
            ""modality_count"": {""$sum"": 1}
        }
    },
    {
        ""$match"": {
            ""modality_count"": {""$gte"": 3}
        }
    },
    {
        ""$project"": {
            ""_id"": 0,
            ""subject_id"": ""$_id"",
            ""unique_modalities"": 1,
            ""modality_count"": 1
        }
    },
    {""$sort"": {""modality_count"": -1}},
    {""$limit"": 5}
]

result = docdb_api_client.aggregate_docdb_records(pipeline=agg_pipeline)
print(json.dumps(result, indent=2))"
Find all experiments where the acquisition.instrument_id doesn't match any instrument.instrument_id in the database.,There are 592 assets where the acquisition.instrument_id doesn't match any instrument.instrument_id ,,,"from aind_data_access_api.document_db import MetadataDbClient

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

# List of known instrument IDs from the previous query result
known_instrument_ids = [
    '440_SmartSPIM3_20240229', 'SmartSPIM_20250209', '440_SmartSPIM3_20240510', 
    'SmartSPIM1-5', '440_SmartSPIM2_20250114', 'SmartSPIM2-1', '440_SmartSPIM2_20241025', 
    'SmartSPIM2-4', '440_SmartSPIM1_20241024', '440_SmartSPIM1_20240710', 'SmartSPIM1-7', 
    '440_SmartSPIM2_20240229', '440_SmartSPIM3_20240308', 'SmartSPIM1-4', 'SmartSPIM1-6', 
    '440_SmartSPIM3_20250125', 'SmartSPIM2-2', 'SmartSPIM1-2', '440_SmartSPIM3_20240321', 
    'SmartSPIM3-2', 'SmartSPIM1-1', 'exaSPIM1-01', '440_SmartSPIM1_20240229', 
    '440_SmartSPIM1_20240613', '440_SmartSPIM3_20241025', '440_SmartSPIM2_20240321', 
    '440_SmartSPIM2_20240514', '440_SmartSPIM1_20250116', '440_SmartSPIM1_20240325'
]

# MongoDB aggregation pipeline
agg_pipeline = [
    {
        ""$match"": {
            ""acquisition.instrument_id"": {""$exists"": True, ""$ne"": None}
        }
    },
    {
        ""$project"": {
            ""_id"": 1, 
            ""name"": 1, 
            ""acquisition_instrument_id"": ""$acquisition.instrument_id""
        }
    },
    {
        ""$match"": {
            ""acquisition_instrument_id"": {""$nin"": known_instrument_ids}
        }
    },
 
]

# Execute the aggregation
result = docdb_api_client.aggregate_docdb_records(
    pipeline=agg_pipeline
)

# Print results
print(""Experiments with unrecognized instrument IDs:"")
for record in result:
    print(f""Name: {record['name']}, Instrument ID: {record['acquisition_instrument_id']}"")

# Optional: Count of unrecognized instrument IDs
print(f""\nTotal unrecognized instrument ID experiments: {len(result)}"")"
what are the unique instrument ids for smartspim experiments,"Unique SmartSPIM Instrument IDs:
440_SmartSPIM1_20240229
440_SmartSPIM1_20240325
440_SmartSPIM1_20240613
440_SmartSPIM1_20240710
440_SmartSPIM1_20241024
440_SmartSPIM1_20250116
440_SmartSPIM2_20240229
440_SmartSPIM2_20240321
440_SmartSPIM2_20240514
440_SmartSPIM2_20241025
440_SmartSPIM2_20250114
440_SmartSPIM3_20240229
440_SmartSPIM3_20240308
440_SmartSPIM3_20240321
440_SmartSPIM3_20240510
440_SmartSPIM3_20241025
440_SmartSPIM3_20250125
SmartSPIM1-1
SmartSPIM1-2
SmartSPIM1-4
SmartSPIM1-5
SmartSPIM1-6
SmartSPIM1-7
SmartSPIM2-1
SmartSPIM2-2
SmartSPIM2-4
SmartSPIM3-2
exaSPIM1-01",,"{""agg_pipeline"":[{""$match"":{""data_description.modality.name"":""Selective plane illumination microscopy""}},{""$project"":{""instrument_id"":""$instrument.instrument_id""}},{""$group"":{""_id"":""$instrument_id""}},{""$sort"":{""_id"":1}}]}","from aind_data_access_api.document_db import MetadataDbClient

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)


agg_pipeline = [
    {
        ""$match"": {
            ""data_description.modality.name"": ""Selective plane illumination microscopy""
        }
    },
    {
        ""$project"": {
            ""instrument_id"": ""$instrument.instrument_id""
        }
    },
    {
        ""$group"": {
            ""_id"": ""$instrument_id""
        }
    },
    {
        ""$sort"": {
            ""_id"": 1
        }
    }
]

result = docdb_api_client.aggregate_docdb_records(
    pipeline=agg_pipeline
)

# Print unique instrument IDs, excluding null values
unique_instrument_ids = [record['_id'] for record in result if record['_id'] is not None]
print(""Unique SmartSPIM Instrument IDs:"")
for instrument_id in unique_instrument_ids:
    print(instrument_id)

print(f""\nTotal unique instrument IDs: {len(unique_instrument_ids)}"")"
"For asset SmartSPIM_675387_2023-05-23_23-05-56, extract all coordinate_transformations from the tiles","Total number of tiles: 84

Unique Coordinate Transformations:
{'translation': [54034, 48622, 4.2], 'type': 'translation'}
{'translation': [47554, 51214, 4.2], 'type': 'translation'}
{'translation': [54034, 40846, 4.2], 'type': 'translation'}
{'translation': [44314, 53806, 4.2], 'type': 'translation'}
{'translation': [54034, 51214, 4.2], 'type': 'translation'}
{'translation': [54034, 46030, 4.2], 'type': 'translation'}
{'translation': [47554, 53806, 4.2], 'type': 'translation'}
{'translation': [50794, 46030, 4.2], 'type': 'translation'}
{'translation': [50794, 56398, 4.2], 'type': 'translation'}
{'translation': [50794, 48622, 4.2], 'type': 'translation'}
{'translation': [47554, 43438, 4.2], 'type': 'translation'}
{'translation': [47554, 40846, 4.2], 'type': 'translation'}
{'translation': [54034, 53806, 4.2], 'type': 'translation'}
{'translation': [44314, 48622, 4.2], 'type': 'translation'}
{'translation': [44314, 43438, 4.2], 'type': 'translation'}
{'translation': [47554, 46030, 4.2], 'type': 'translation'}
{'translation': [47554, 56398, 4.2], 'type': 'translation'}
{'translation': [50794, 53806, 4.2], 'type': 'translation'}
{'translation': [54034, 43438, 4.2], 'type': 'translation'}
{'translation': [44314, 40846, 4.2], 'type': 'translation'}
{'translation': [50794, 43438, 4.2], 'type': 'translation'}
{'translation': [54034, 56398, 4.2], 'type': 'translation'}
{'translation': [44314, 56398, 4.2], 'type': 'translation'}
{'scale': [1.8, 1.8, 2], 'type': 'scale'}
{'translation': [44314, 46030, 4.2], 'type': 'translation'}
{'translation': [44314, 51214, 4.2], 'type': 'translation'}
{'translation': [50794, 51214, 4.2], 'type': 'translation'}
{'translation': [50794, 40846, 4.2], 'type': 'translation'}
{'translation': [47554, 48622, 4.2], 'type': 'translation'}",,"{""filter"":{""name"":""SmartSPIM_675387_2023-05-23_23-05-56""},""projection"":{""acquisition.tiles.coordinate_transformations"":1}}","import json
from aind_data_access_api.document_db import MetadataDbClient

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

# Filter for the specific SmartSPIM asset
filter = {""name"": ""SmartSPIM_675387_2023-05-23_23-05-56""}

# Project only the coordinate transformations
projection = {""acquisition.tiles.coordinate_transformations"": 1}

# Retrieve the records
records = docdb_api_client.retrieve_docdb_records(
    filter_query=filter,
    projection=projection
)

# Extract and print coordinate transformations
for record in records:
    tiles = record.get('acquisition', {}).get('tiles', [])

    print(""Total number of tiles:"", len(tiles))

    # Collect unique coordinate transformations
    unique_transformations = set()
    for tile in tiles:
        transformations = tile.get('coordinate_transformations', [])
        for transform in transformations:
            unique_transformations.add(json.dumps(transform, sort_keys=True))

    print(""\nUnique Coordinate Transformations:"")
    for transform in unique_transformations:
        print(json.loads(transform))"
"for the thalamus in the middle project, what brain structures are data collected from?","Brain structures data was collected from:
[
   {
      ""brain_structure"": ""VM""
   },
   {
      ""brain_structure"": ""aPVT""
   },
   {
      ""brain_structure"": ""pPVT""
   },
   {
      ""brain_structure"": ""c. ALM""
   },
   {
      ""brain_structure"": ""mPFC""
   },
   {
      ""brain_structure"": ""PVT""
   },
   {
      ""brain_structure"": ""ALM""
   },
   {
      ""brain_structure"": ""Isocortex""
   },
   {
      ""brain_structure"": ""c. mPFC""
   },
   {
      ""brain_structure"": null
   },
   {
      ""brain_structure"": ""IL""
   }
]
",,"{""filter"":{""data_description.project_name"":""Thalamus in the middle""},""projection"":{""data_description.project_name"":1,""procedures.subject_procedures.procedures.targeted_structure"":1}}","import json
from collections import Counter

from aind_data_access_api.document_db import MetadataDbClient

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

agg_pipeline = [
    {
        ""$match"": {
            ""data_description.project_name"": ""Thalamus in the middle""
        }
    },
    {
        ""$unwind"": ""$procedures.subject_procedures""
    },
    {
        ""$unwind"": ""$procedures.subject_procedures.procedures""
    },
    {
        ""$group"": {
            ""_id"": ""$procedures.subject_procedures.procedures.targeted_structure""
        }
    }
]

result = docdb_api_client.aggregate_docdb_records(
    pipeline=agg_pipeline
)

# Count occurrences of each targeted structure
structure_counts = Counter()
for record in result:
    if record['_id'] is not None:
        structure_counts[record['_id']] += 1

print(""Targeted Brain Structures in 'Thalamus in the middle' Project:"")
for structure, count in structure_counts.items():
    print(f""{structure}: {count} records"")"
"generate a query i can use to find the number of animals in the thalamus in the middle project who received injections in the following coordinate: AP: 2.8, ML: 0.2, DV: 0.6?","import json
from aind_data_access_api.document_db import MetadataDbClient

API_GATEWAY_HOST = ""api.allenneuraldynamics.org""
DATABASE = ""metadata_index""
COLLECTION = ""data_assets""

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

agg_pipeline = [
    {
        ""$match"": {
            ""data_description.project_name"": ""Thalamus in the middle"",
            ""procedures.subject_procedures.procedures.injection_coordinate_ap"": ""2.8"",
            ""procedures.subject_procedures.procedures.injection_coordinate_ml"": ""0.2"", 
            ""procedures.subject_procedures.procedures.injection_coordinate_depth"": ""0.6""
        }
    },
    {
        ""$group"": {
            ""_id"": ""$procedures.subject_id"", 
            ""count"": {""$sum"": 1}
        }
    },
    {
        ""$count"": ""total_unique_animals""
    }
]

result = docdb_api_client.aggregate_docdb_records(
    pipeline=agg_pipeline
)

print(json.dumps(result, indent=2))",,"agg_pipeline = [
    {
        ""$match"": {
            ""data_description.project_name"": ""Thalamus in the middle"",
            ""procedures.subject_procedures.procedures.injection_coordinate_ap"": ""2.8"",
            ""procedures.subject_procedures.procedures.injection_coordinate_ml"": ""0.2"", 
            ""procedures.subject_procedures.procedures.injection_coordinate_depth"": ""0.6""
        }
    },
    {
        ""$group"": {
            ""_id"": ""$procedures.subject_id"", 
            ""count"": {""$sum"": 1}
        }
    },
    {
        ""$count"": ""total_unique_animals""
    }
]","import json
from aind_data_access_api.document_db import MetadataDbClient


docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

agg_pipeline = [
    {
        ""$match"": {
            ""data_description.project_name"": ""Thalamus in the middle"",
            ""procedures.subject_procedures.procedures.injection_coordinate_ap"": ""2.8"",
            ""procedures.subject_procedures.procedures.injection_coordinate_ml"": ""0.2"", 
            ""procedures.subject_procedures.procedures.injection_coordinate_depth"": ""0.6""
        }
    },
    {
        ""$group"": {
            ""_id"": ""$procedures.subject_id"", 
            ""count"": {""$sum"": 1}
        }
    },
    {
        ""$count"": ""total_unique_animals""
    }
]

result = docdb_api_client.aggregate_docdb_records(
    pipeline=agg_pipeline
)

print(json.dumps(result, indent=2))"
determine the unique genotypes used in the Brain Computer Interface project,"There are 12 unique genotypes. These are the genotypes: 
Emx1-IRES-Cre/wt;Camk2a-tTA/wt;Ai94(TITL-GCaMP6s)/wt
Camk2a-tTA/wt;tetO-GCaMP6s/wt
wt/wt
Slc17a6-IRES-Cre/wt;Ai230(TIT2L-XCaMPG-WPRE-ICL-ChRmine-oScarlet-IRES2-tTA2-WPRE)-hyg/wt
Camk2a-tTA/wt;TetO-jGCaMP8s-01/wt
Slc17a7-IRES2-Cre/wt;Ai228(TIT2L-GC6m-WPRE-ICL-ChRmine-oScarlet-WPRE-ICL-IRES-tTA2-WPRE)-hyg/wt
Oi8(H11-CAG-Cas9)/Oi8(H11-CAG-Cas9)
Dbh-Cre-KI/wt;Thy1-jRGECO1a-WPRE/wt
None
Slc17a7-IRES2-Cre/wt;Camk2a-tTA/wt;Ai94(TITL-GCaMP6s)/wt
Camk2a-CreERT2/wt;Ai228(TIT2L-GC6m-WPRE-ICL-ChRmine-oScarlet-WPRE-ICL-IRES-tTA2-WPRE)-hyg/wt
Dbh-Cre-KI/wt",,"{""agg_pipeline"":[{""$match"":{""data_description.project_name"":{""$regex"":""Brain Computer Interface"",""$options"":""i""}}},{""$group"":{""_id"":""$subject.genotype""}},{""$project"":{""genotype"":""$_id"",""_id"":0}}]}","import json

from aind_data_access_api.document_db import MetadataDbClient


docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

agg_pipeline = [
    {
        ""$match"": {
            ""data_description.project_name"": {""$regex"": ""Brain Computer Interface"", ""$options"": ""i""}
        }
    },
    {
        ""$group"": {
            ""_id"": ""$subject.genotype""
        }
    },
    {
        ""$project"": {
            ""genotype"": ""$_id"",
            ""_id"": 0
        }
    }
]

result = docdb_api_client.aggregate_docdb_records(
    pipeline=agg_pipeline
)

# Print unique genotypes
print(""Unique Genotypes in Brain Computer Interface Project:"")
for record in result:
    print(record.get('genotype', 'No genotype specified'))"
what are the unique viruses in the brain computer interface project?,"Here are the unique viruses: 
AiP32125
CamKIIa_ChrimsonR_FusionRed_Kv2.1
VIR32066_PHPeB
VIR32098_PHPeB
VT5417G
it's not in the database yet..
pAAV-CaMKIIa-ChRmine-oScarlet-Kv2.1-WPRE - 7413
pAAV-hSyn-RiboL1-jGCaMP8s-WPRE
pAAV-hSyn1-RiboL1-GCaMP8s-WPRE",,"{""agg_pipeline"":[{""$match"":{""data_description.project_name"":{""$regex"":""Brain Computer Interface"",""$options"":""i""}}},{""$match"":{""procedures.subject_procedures"":{""$exists"":true,""$ne"":[]}}},{""$unwind"":""$procedures.subject_procedures""},{""$unwind"":""$procedures.subject_procedures.procedures""},{""$match"":{""procedures.subject_procedures.procedures.injection_materials"":{""$exists"":true,""$ne"":[]}}},{""$unwind"":""$procedures.subject_procedures.procedures.injection_materials""},{""$match"":{""procedures.subject_procedures.procedures.injection_materials.material_type"":""Virus""}},{""$group"":{""_id"":""$procedures.subject_procedures.procedures.injection_materials.name""}},{""$project"":{""virus_name"":""$_id"",""_id"":0}}]}","import json

from aind_data_access_api.document_db import MetadataDbClient

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

agg_pipeline = [
    {'$match': {'data_description.project_name': {'$regex': 'Brain Computer Interface', '$options': 'i'}}},
    {'$match': {'procedures.subject_procedures': {'$exists': True, '$ne': []}}},
    {'$unwind': '$procedures.subject_procedures'},
    {'$unwind': '$procedures.subject_procedures.procedures'},
    {'$match': {'procedures.subject_procedures.procedures.injection_materials': {'$exists': True, '$ne': []}}},
    {'$unwind': '$procedures.subject_procedures.procedures.injection_materials'},
    {'$match': {'procedures.subject_procedures.procedures.injection_materials.material_type': 'Virus'}},
    {'$group': {'_id': '$procedures.subject_procedures.procedures.injection_materials.name'}},
    {'$project': {'virus_name': '$_id', '_id': 0}}
]

result = docdb_api_client.aggregate_docdb_records(
    pipeline=agg_pipeline
)

# Print unique viruses
print(""Unique Viruses in Brain Computer Interface Project:"")
for virus in result:
    print(virus['virus_name'])"
" list the subject ids, and virus names for mice in the ""Thalamus in the middle"" project that had injections in VM","Subject ID: 658207
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 658208
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 658209
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 658207
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 673394
Virus Names:
- ['SL1-hSyn-Cre', 'FluoSphere (Dark Red)']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 666941
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 662616
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 662616
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 666941
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 668125
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 668126
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 661792
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 661792
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 661790
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 662585
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 662585
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 662616
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 662616
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 669120
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 669120
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 656374
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 669121
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 669121
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 658208
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 673394
Virus Names:
- ['SL1-hSyn-Cre', 'FluoSphere (Dark Red)']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 673393
Virus Names:
- ['SL1-hSyn-Cre', 'FluoSphere (Dark Red)']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 652504
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 654095
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 652504
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---
Subject ID: 652505
Virus Names:
- ['SL1-hSyn-Cre', 'AAV1-CAG-H2B-mTurquoise2-WPRE']
- ['AAV-Syn-DIO-TVA66T-dTomato-CVS N2cG']
- ['EnvA CVS-N2C-histone-GFP']
---",,"{""agg_pipeline"":[{""$match"":{""data_description.project_name"":""Thalamus in the middle"",""procedures.subject_procedures"":{""$elemMatch"":{""procedures"":{""$elemMatch"":{""targeted_structure"":""VM""}}}}}},{""$project"":{""subject_id"":""$subject.subject_id"",""procedures"":""$procedures.subject_procedures""}}]}","import json

from aind_data_access_api.document_db import MetadataDbClient

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

agg_pipeline = [
    {
        ""$match"": {
            ""data_description.project_name"": ""Thalamus in the middle"", 
            ""procedures.subject_procedures"": {
                ""$elemMatch"": {
                    ""procedures"": {
                        ""$elemMatch"": {
                            ""targeted_structure"": ""VM""
                        }
                    }
                }
            }
        }
    },
    {
        ""$project"": {
            ""subject_id"": ""$subject.subject_id"",
            ""virus_names"": ""$procedures.subject_procedures.procedures.injection_materials.name""
        }
    }
]

result = docdb_api_client.aggregate_docdb_records(
    pipeline=agg_pipeline
)

# Process and print the results
for record in result:
    print(f""Subject ID: {record.get('subject_id')}"")
    print(""Virus Names:"")
    for virus_list in record.get('virus_names', []):
        for virus in virus_list:
            print(f""- {virus}"")
    print(""---"")"
"Which experimenter who conducted the most sessions in the past 6 months, given that the date is 3/31/25?",Bowen Tan,,"{""agg_pipeline"":[{""$match"":{""$or"":[{""session.session_start_time"":{""$gte"":""2024-10-01T00:00:00"",""$lte"":""2025-03-31T23:59:59""}},{""acquisition.session_start_time"":{""$gte"":""2024-10-01T00:00:00"",""$lte"":""2025-03-31T23:59:59""}}]}},{""$project"":{""experimenter"":{""$cond"":{""if"":{""$isArray"":""$session.experimenter_full_name""},""then"":""$session.experimenter_full_name"",""else"":{""$cond"":{""if"":{""$isArray"":""$acquisition.experimenter_full_name""},""then"":""$acquisition.experimenter_full_name"",""else"":[]}}}}}},{""$unwind"":""$experimenter""},{""$group"":{""_id"":""$experimenter"",""count"":{""$sum"":1}}},{""$sort"":{""count"":-1}},{""$limit"":1}]}",
Give me a timeline of Data Acquisition Streams for single-plane-ophys_621025_2022-07-05_17-48-34,"Stream 1:
Start Time: 2022-07-05T16:45:38.865000-07:00
End Time: 2022-07-05T16:46:40.913314-07:00
DAQ Names: ['PXI']
Stream Modalities: ['Planar optical physiology']
Notes: tiff_stem:stack

Stream 2:
Start Time: 2022-07-05T17:48:34.118000-07:00
End Time: 2022-07-05T17:49:37.048710-07:00
DAQ Names: ['PXI']
Stream Modalities: ['Planar optical physiology']
Notes: tiff_stem:stackpost

Stream 3:
Start Time: 2022-07-05T17:43:34.002000-07:00
End Time: 2022-07-05T17:43:56.011630-07:00
DAQ Names: ['PXI']
Stream Modalities: ['Planar optical physiology']
Notes: tiff_stem:spontPost

Stream 4:
Start Time: 2022-07-05T17:44:09.611000-07:00
End Time: 2022-07-05T17:48:02.349575-07:00
DAQ Names: ['PXI']
Stream Modalities: ['Planar optical physiology']
Notes: tiff_stem:spontPost_again

Stream 5:
Start Time: 2022-07-05T16:49:55.924999-07:00
End Time: 2022-07-05T16:50:51.417821-07:00
DAQ Names: ['PXI']
Stream Modalities: ['Planar optical physiology']
Notes: tiff_stem:spont

Stream 6:
Start Time: 2022-07-05T16:53:21.731999-07:00
End Time: 2022-07-05T16:57:17.360622-07:00
DAQ Names: ['PXI']
Stream Modalities: ['Planar optical physiology']
Notes: tiff_stem:spont_again

Stream 7:
Start Time: 2022-07-05T16:57:53.490999-07:00
End Time: 2022-07-05T17:15:04.813925-07:00
DAQ Names: ['PXI']
Stream Modalities: ['Planar optical physiology', 'Behavior', 'Behavior videos']
Notes: tiff_stem:Neuron1

Stream 8:
Start Time: 2022-07-05T17:17:57.798000-07:00
End Time: 2022-07-05T17:43:09.523928-07:00
DAQ Names: ['PXI']
Stream Modalities: ['Planar optical physiology']
Notes: tiff_stem:_slm2",,"{""filter"":{""name"":""single-plane-ophys_621025_2022-07-05_17-48-34""},""projection"":{""session.data_streams"":1,""name"":1}}","import json
from datetime import datetime

from aind_data_access_api.document_db import MetadataDbClient

API_GATEWAY_HOST = ""api.allenneuraldynamics.org""
DATABASE = ""metadata_index""
COLLECTION = ""data_assets""

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

# Filter for the specific session name
filter = {""name"": ""single-plane-ophys_621025_2022-07-05_17-48-34""}

# Project only the data streams
projection = {""session.data_streams"": 1, ""name"": 1}

# Retrieve the records
records = docdb_api_client.retrieve_docdb_records(
    filter_query=filter,
    projection=projection
)

# Process and print the data streams
data_streams = records[0]['session']['data_streams']

print(""Data Acquisition Streams Timeline:"")
for i, stream in enumerate(data_streams, 1):
    print(f""\nStream {i}:"")
    print(f""Start Time: {stream['stream_start_time']}"")
    print(f""End Time: {stream['stream_end_time']}"")
    print(f""DAQ Names: {stream['daq_names']}"")
    print(f""Stream Modalities: {[mod['name'] for mod in stream['stream_modalities']]}"")
    print(f""Notes: {stream['notes']}"")"
return the count of how many subjects had sessions that contained both optical physiology and behavior data streams,There are 101 subjects that match the criteria.,,"{""agg_pipeline"":[{""$match"":{""data_description.modality"":{""$exists"":true}}},{""$project"":{""subject_id"":""$data_description.subject_id"",""modalities"":""$data_description.modality.name""}},{""$match"":{""subject_id"":{""$exists"":true,""$ne"":null}}},{""$group"":{""_id"":""$subject_id"",""modalities"":{""$addToSet"":""$modalities""}}},{""$match"":{""modalities"":{""$all"":[{""$elemMatch"":{""$regex"":""optical physiology"",""$options"":""i""}},{""$elemMatch"":{""$regex"":""behavior"",""$options"":""i""}}]}}},{""$project"":{""_id"":0,""subject_id"":""$_id"",""modalities"":1}},{""$limit"":50}]}","
from aind_data_access_api.document_db import MetadataDbClient

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)
agg_pipeline = [
    {
        ""$match"": {
            ""data_description.modality"": {""$exists"": True}
        }
    },
    {
        ""$project"": {
            ""subject_id"": ""$data_description.subject_id"", 
            ""modalities"": ""$data_description.modality.name""
        }
    },
    {
        ""$match"": {
            ""subject_id"": {""$exists"": True, ""$ne"": None}
        }
    },
    {
        ""$unwind"": ""$modalities""
    },
    {
        ""$group"": {
            ""_id"": ""$subject_id"", 
            ""modalities"": {""$addToSet"": ""$modalities""}
        }
    },
    {
        ""$match"": {
            ""$and"": [
                {""modalities"": {""$regex"": ""optical physiology"", ""$options"": ""i""}},
                {""modalities"": {""$regex"": ""behavior"", ""$options"": ""i""}}
            ]
        }
    },
    {
        ""$project"": {
            ""_id"": 0, 
            ""subject_id"": ""$_id"", 
            ""modalities"": 1
        }
    }
]

result = docdb_api_client.aggregate_docdb_records(
    pipeline=agg_pipeline
)


# Optional: Count of subjects
print(f""Total Subjects Found: {len(result)}"")"
What is the genotype for subject 675387?,The genotype for subject 675387 is wt/wt,,"{
""filter"":{
""subject.subject_id"":""675387""
}
""projection"":{
""subject.genotype"":1
}
}","import json

from aind_data_access_api.document_db import MetadataDbClient

API_GATEWAY_HOST = ""api.allenneuraldynamics.org""
DATABASE = ""metadata_index""
COLLECTION = ""data_assets""

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

filter = {""subject.subject_id"": ""675387""}
projection = {
    ""subject.subject_id"": 1,
    ""subject.genotype"": 1
}

records = docdb_api_client.retrieve_docdb_records(
    filter_query=filter,
    projection=projection,
)

# Print the results
print(""Genotype for subject 675387:"")
for record in records:
    print(f""Subject ID: {record['subject']['subject_id']}"")
    print(f""Genotype: {record['subject']['genotype']}"")"
What are all the assets using mouse 744330,"""""""behavior_744330_2024-09-18_09-19-56_processed_2024-09-25_04-01-44"""", """"behavior_744330_2024-10-09_09-28-02"""", """"behavior_744330_2024-12-05_17-09-52"""", """"behavior_744330_2024-12-04_13-24-28"""", """"behavior_744330_2024-12-02_13-45-51"""", """"behavior_744330_2024-12-03_10-56-30"""", """"behavior_744330_2024-11-13_13-59-24"""", """"behavior_744330_2024-11-21_14-06-34"""", 
""""behavior_744330_2024-11-25_13-55-30"""", """"behavior_744330_2024-10-04_09-21-04_processed_2025-02-23_03-11-03"""",  """"behavior_744330_2024-09-20_09-07-42_processed_2025-02-23_01-24-27"""", """"behavior_744330_2024-09-16_09-33-31_processed_2025-02-23_00-40-08""""""",,"{""filter"":{""subject.subject_id"":""744330""},""projection"":{""name"":1,""_id"":0}}","import json

from aind_data_access_api.document_db import MetadataDbClient


docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

filter = {""subject.subject_id"":""744330""}
projection = {
    ""name"": 1
}

records = docdb_api_client.retrieve_docdb_records(
    filter_query=filter,
    projection=projection,
)

print(records)"
Write a MongoDB query to find the genotype of SmartSPIM_675387_2023-05-23_23-05-56,"
                    <query>{
                            ""$match"": {""name"":""SmartSPIM_675387_2023-05-23_23-05-56""},
                            ""$project"": {""_id"": 0, ""genotype"": ""$subject.genotype""}
                    }</query>
                    To find the genotype for the experiment with the name ""SmartSPIM_675387_2023-05-23_23-05-56"", the MongoDB query would be:
                    1. The `$match` stage filters the documents to only include the one with the specified name.
                    2. The `$project` stage excludes the `_id` field and includes the `genotype` field from the nested `subject` object.
                    The retrieved output shows that the genotype for this experiment is ""wt/wt"".
                    ",,"{
""filter"":{
""name"":""SmartSPIM_675387_2023-05-23_23-05-56""
}
""projection"":{
""subject.genotype"":1
""_id"":0
}
}","import json

from aind_data_access_api.document_db import MetadataDbClient

API_GATEWAY_HOST = ""api.allenneuraldynamics.org""
DATABASE = ""metadata_index""
COLLECTION = ""data_assets""

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

filter = {""name"": ""SmartSPIM_675387_2023-05-23_23-05-56""}
projection = {
    ""subject.subject_id"": 1,
    ""subject.genotype"": 1
}

records = docdb_api_client.retrieve_docdb_records(
    filter_query=filter,
    projection=projection,
)

# Print the results
print(""Genotype for subject 675387:"")
for record in records:
    print(f""Subject ID: {record['subject']['subject_id']}"")
    print(f""Genotype: {record['subject']['genotype']}"")"
What is the genotype for the subject in ecephys_737403_2024-09-27_10-30-18_sorted_2024-11-19_19-28-46?,The genotype for the subject in ecephys_737403_2024-09-27_10-30-18_sorted_2024-11-19_19-28-46 is Vip-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt,,"{
""filter"":{
""name"":""SmartSPIM_675387_2023-05-23_23-05-56""
}
""projection"":{
""subject.genotype"":1
}
}","import json

from aind_data_access_api.document_db import MetadataDbClient

API_GATEWAY_HOST = ""api.allenneuraldynamics.org""
DATABASE = ""metadata_index""
COLLECTION = ""data_assets""

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

filter = {""name"": ""ecephys_737403_2024-09-27_10-30-18_sorted_2024-11-19_19-28-46""}
projection = {
    ""subject.subject_id"": 1,
    ""subject.genotype"": 1
}

records = docdb_api_client.retrieve_docdb_records(
    filter_query=filter,
    projection=projection,
)

# Print the results
print(""Genotype for subject 737403:"")
for record in records:
    print(f""Subject ID: {record['subject']['subject_id']}"")
    print(f""Genotype: {record['subject']['genotype']}"")"
What are the stereotactic coordinates for all fiber implants in asset ophys_661797_2023-02-15_11-19-14?,"Based on the provided context, the stereotactic coordinates for the fiber implants in asset ""ophys_661797_2023-02-15_11-19-14"" are:

Probe A:

AP (anterior-posterior): 1.2 mm
ML (medial-lateral): -1.3 mm (left hemisphere)
DV (dorsal-ventral): 4.0 mm
Angle: 0.0 degrees
Probe B:

AP (anterior-posterior): 1.2 mm
ML (medial-lateral): 1.3 mm (right hemisphere)
DV (dorsal-ventral): 4.0 mm
Angle: 0.0 degrees
Both fiber implants were placed at the same depth and AP coordinates, but in opposite hemispheres.",,"{""filter"":{""name"":""ophys_661797_2023-02-15_11-19-14""},""projection"":{""procedures.subject_procedures"":1}}","import json
from aind_data_access_api.document_db import MetadataDbClient

API_GATEWAY_HOST = ""api.allenneuraldynamics.org""
DATABASE = ""metadata_index""
COLLECTION = ""data_assets""

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

# Filter for the specific asset name
filter = {""name"": ""ophys_661797_2023-02-15_11-19-14""}

# Project to get the fiber implant procedures
projection = {
    ""procedures.subject_procedures"": 1
}

# Retrieve the records
records = docdb_api_client.retrieve_docdb_records(
    filter_query=filter,
    projection=projection
)

# Extract and print fiber implant coordinates
fiber_implants = []
for record in records:
    for procedure in record.get('procedures', {}).get('subject_procedures', []):
        if procedure.get('procedure_type') == 'Fiber implant':
            probe_info = procedure.get('probes', {})
            fiber_implant = {
                ""probe_name"": probe_info.get('name'),
                ""stereotactic_coordinates"": {
                    ""AP"": probe_info.get('stereotactic_coordinate_ap'),
                    ""ML"": probe_info.get('stereotactic_coordinate_ml'),
                    ""DV"": probe_info.get('stereotactic_coordinate_dv')
                },
                ""coordinate_unit"": probe_info.get('stereotactic_coordinate_unit'),
                ""angle"": f""{probe_info.get('angle')} {probe_info.get('angle_unit')}""
            }
            fiber_implants.append(fiber_implant)

# Print the results
print(""Fiber Implant Stereotactic Coordinates:"")
print(json.dumps(fiber_implants, indent=2))"
What percentage of fiber photometry experiments include complementary behavioral data,"Analysis of the Results:

Total Fiber Photometry Experiments: 2062
Experiments with Behavioral Data: 1985
Percentage of Experiments with Behavioral Data: 96.27%",,"{""agg_pipeline"":[{""$match"":{""data_description.modality.name"":{""$regex"":""fiber photometry"",""$options"":""i""}}},{""$project"":{""_id"":1,""name"":1,""has_behavior"":{""$cond"":[{""$or"":[{""$in"":[""Behavior"",""$data_description.modality.name""]},{""$in"":[""Behavior videos"",""$data_description.modality.name""]},{""$in"":[""Trained behavior"",""$data_description.modality.name""]}]},true,false]}}},{""$group"":{""_id"":null,""total_count"":{""$sum"":1},""with_behavior_count"":{""$sum"":{""$cond"":[""$has_behavior"",1,0]}}}},{""$project"":{""_id"":0,""total_count"":1,""with_behavior_count"":1,""percentage"":{""$multiply"":[{""$divide"":[""$with_behavior_count"",""$total_count""]},100]}}}]}","import json
from aind_data_access_api.document_db import MetadataDbClient

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

agg_pipeline = [
    {
        ""$match"": {
            ""data_description.modality.name"": {""$regex"": ""fiber photometry"", ""$options"": ""i""}
        }
    },
    {
        ""$project"": {
            ""_id"": 1,
            ""name"": 1,
            ""has_behavior"": {
                ""$cond"": [
                    {
                        ""$or"": [
                            {""$in"": [""Behavior"", ""$data_description.modality.name""]},
                            {""$in"": [""Behavior videos"", ""$data_description.modality.name""]},
                            {""$in"": [""Trained behavior"", ""$data_description.modality.name""]}
                        ]
                    },
                    True,
                    False
                ]
            }
        }
    },
    {
        ""$group"": {
            ""_id"": None,
            ""total_count"": {""$sum"": 1},
            ""with_behavior_count"": {""$sum"": {""$cond"": [""$has_behavior"", 1, 0]}}
        }
    },
    {
        ""$project"": {
            ""_id"": 0,
            ""total_count"": 1,
            ""with_behavior_count"": 1,
            ""percentage"": {""$multiply"": [{""$divide"": [""$with_behavior_count"", ""$total_count""]}, 100]}
        }
    }
]

result = docdb_api_client.aggregate_docdb_records(pipeline=agg_pipeline)
print(json.dumps(result, indent=2))"
Compare the processing durations for assets from the same subject (661797) across different experimental sessions.,"Processing Durations for Subject 661797:

Session: HSFP_661797_2023-02-15_11-17-30
Version: 0.16.2
Start Time: 2023-05-10 20:46:59.340832+00:00
End Time: 2023-05-10 20:48:47.913348+00:00
Duration: 0:01:48.572516

Session: HSFP_661797_2023-02-15_11-19-14
Version: 0.16.2
Start Time: 2023-05-10 20:48:50.288500+00:00
End Time: 2023-05-10 20:52:03.246558+00:00
Duration: 0:03:12.958058

Session: HSFP_661797_2023-02-15_11-30-14
Version: 0.16.2
Start Time: 2023-05-10 20:57:46.472980+00:00
End Time: 2023-05-10 20:58:00.440152+00:00
Duration: 0:00:13.967172

Session: ophys_661797_2023-02-15_11-17-30
Version: 0.14.1
Start Time: 2023-04-28 22:52:21.482118+00:00
End Time: 2023-04-28 22:54:11.934957+00:00
Duration: 0:01:50.452839

Session: ophys_661797_2023-02-15_11-19-14
Version: 0.14.1
Start Time: 2023-04-28 22:54:14.586823+00:00
End Time: 2023-04-28 22:57:37.682176+00:00
Duration: 0:03:23.095353

Session: ophys_661797_2023-02-15_11-21-35
Version: 0.14.1
Start Time: 2023-04-28 22:57:40.368245+00:00
End Time: 2023-04-28 23:04:43.812168+00:00
Duration: 0:07:03.443923

Session: ophys_661797_2023-02-15_11-30-14
Version: 0.14.1
Start Time: 2023-04-28 23:04:47.088237+00:00
End Time: 2023-04-28 23:05:01.978967+00:00
Duration: 0:00:14.890730",,"{""filter"":{""subject.subject_id"":""661797"",""processing"":{""$exists"":true}},""projection"":{""_id"":1,""name"":1,""processing"":1}}","from datetime import datetime

from aind_data_access_api.document_db import MetadataDbClient

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

# Filter for subject 661797 with processing information
filter = {
    'subject.subject_id': '661797', 
    'processing': {'$exists': True}
}

projection = {
    'name': 1, 
    'processing.data_processes.start_date_time': 1,
    'processing.data_processes.end_date_time': 1,
    'processing.data_processes.version': 1
}

records = docdb_api_client.retrieve_docdb_records(
    filter_query=filter,
    projection=projection
)

# Process and print processing durations
print(""Processing Durations for Subject 661797:\n"")
for record in records:
    name = record.get('name', 'Unknown')
    processes = record.get('processing', {}).get('data_processes', [])

    for process in processes:
        start_time = process.get('start_date_time')
        end_time = process.get('end_date_time')
        version = process.get('version')

        if start_time and end_time:
            start = datetime.fromisoformat(start_time.replace('Z', '+00:00'))
            end = datetime.fromisoformat(end_time.replace('Z', '+00:00'))
            duration = end - start

            print(f""Session: {name}"")
            print(f""Version: {version}"")
            print(f""Start Time: {start}"")
            print(f""End Time: {end}"")
            print(f""Duration: {duration}\n"")"
How many records are stored in the database?,"There are 15,000 records found in the database.
",,"{""agg_pipeline"":[{""$count"":""total_records""}]}","from aind_data_access_api.document_db import MetadataDbClient

API_GATEWAY_HOST = ""api.allenneuraldynamics.org""
DATABASE = ""metadata_index""
COLLECTION = ""data_assets""

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

# Using aggregation to count all records
agg_pipeline = [
    {
        ""$count"": ""total_records""
    }
]

result = docdb_api_client.aggregate_docdb_records(
    pipeline=agg_pipeline
)

# Print the result
if result:
    print(f""Total number of records in the database: {result[0]['total_records']}"")
else:
    print(""No records found or error in query"")"
How many assets have injections in the isocortex,There are 111 assets that have injections in the isocortex,,"{""agg_pipeline"":[{""$match"":{""procedures.subject_procedures"":{""$elemMatch"":{""procedures"":{""$elemMatch"":{""targeted_structure"":{""$regex"":""isocortex"",""$options"":""i""}}}}}}},{""$count"":""total""}]}","from aind_data_access_api.document_db import MetadataDbClient


docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

# Filter for assets with isocortex targeted procedures
filter_query = {
    ""procedures.subject_procedures.procedures.targeted_structure"": {
        ""$regex"": ""isocortex"", 
        ""$options"": ""i""
    }
}

# Retrieve records
records = docdb_api_client.retrieve_docdb_records(
    filter_query=filter_query
)

# Count the number of unique assets
num_assets = len(records)
"
What are the unique modalities found in the database?,"""The unique modalities in the database are Behavior
Behavior videos
Dual inverted selective plane illumination microscopy
Electrophysiology
Extracellular electrophysiology
Fiber photometry
Hyperspectral fiber photometry
Planar optical physiology
Selective plane illumination microscopy
Trained behavior""",,"{""agg_pipeline"":[{""$project"":{""modality"":""$data_description.modality.name""}},{""$unwind"":{""path"":""$modality"",""preserveNullAndEmptyArrays"":true}},{""$group"":{""_id"":""$modality""}},{""$sort"":{""_id"":1}}]}","from aind_data_access_api.document_db import MetadataDbClient

API_GATEWAY_HOST = ""api.allenneuraldynamics.org""
DATABASE = ""metadata_index""
COLLECTION = ""data_assets""

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

agg_pipeline = [
    {'$project': {'modality': '$data_description.modality.name'}},
    {'$unwind': {'path': '$modality', 'preserveNullAndEmptyArrays': True}},
    {'$group': {'_id': '$modality'}},
    {'$sort': {'_id': 1}}
]

result = docdb_api_client.aggregate_docdb_records(
    pipeline=agg_pipeline
)

# Print unique modalities, filtering out null values
unique_modalities = [modality['_id'] for modality in result if modality['_id'] is not None]
print(""Unique Modalities:"")
for modality in unique_modalities:
    print(f""- {modality}"")"
Which channels were imaged in asset SmartSPIM_692908_2023-11-08_16-48-13_stitched_2023-11-09_11-12-06?,"The channels imaged in the asset are 488 nm, 561 nm, and 639 nm.",,"{""filter"":{""name"":""SmartSPIM_692908_2023-11-08_16-48-13_stitched_2023-11-09_11-12-06""},""projection"":{""acquisition.tiles.channel"":1}}","from aind_data_access_api.document_db import MetadataDbClient

# API setup
API_GATEWAY_HOST = ""api.allenneuraldynamics.org""
DATABASE = ""metadata_index""
COLLECTION = ""data_assets""

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

# Find the specific asset
filter_query = {
    ""name"": ""SmartSPIM_692908_2023-11-08_16-48-13_stitched_2023-11-09_11-12-06""
}

# Project only the acquisition tiles with channel information
projection = {
    ""acquisition.tiles.channel.channel_name"": 1,
    ""acquisition.tiles.channel.laser_wavelength"": 1,
    ""acquisition.tiles.channel.filter_wheel_index"": 1
}

# Retrieve the record
record = docdb_api_client.retrieve_docdb_records(
    filter_query=filter_query,
    projection=projection
)

# Process the results to extract unique channels
if record and len(record) > 0:
    tiles = record[0].get(""acquisition"", {}).get(""tiles"", [])

    # Extract unique channels
    unique_channels = set()
    channel_details = []

    for tile in tiles:
        if ""channel"" in tile:
            channel_name = tile[""channel""].get(""channel_name"")
            wavelength = tile[""channel""].get(""laser_wavelength"")
            filter_index = tile[""channel""].get(""filter_wheel_index"")

            channel_key = f""{channel_name}_{wavelength}_{filter_index}""
            if channel_key not in unique_channels:
                unique_channels.add(channel_key)
                channel_details.append({
                    ""channel_name"": channel_name,
                    ""laser_wavelength"": wavelength,
                    ""filter_wheel_index"": filter_index
                })

    print(f""Unique channels imaged in SmartSPIM_692908_2023-11-08_16-48-13_stitched_2023-11-09_11-12-06:"")
    for i, channel in enumerate(channel_details, 1):
        print(f""{i}. Channel: {channel['channel_name']}, Wavelength: {channel['laser_wavelength']}nm, Filter Index: {channel['filter_wheel_index']}"")
else:
    print(""Asset not found or has no channel information."")"
What is the total duration of the imaging session for the subject in SmartSPIM_675387_2023-05-23_23-05-56,The total duration of the imaging session for the subject in SmartSPIM_675387_2023-05-23_23-05-56 was approximately 5 hours and 4 minutes. This can be calculated from the session_start_time of 2023-05-23T23:05:56 and the session_end_time of 2023-05-24T04:10:10 provided in the context.,,"{""filter"":{""name"":""SmartSPIM_675387_2023-05-23_23-05-56""},""projection"":{""acquisition.session_start_time"":1,""acquisition.session_end_time"":1}}","import json
from datetime import datetime
from aind_data_access_api.document_db import MetadataDbClient

API_GATEWAY_HOST = ""api.allenneuraldynamics.org""
DATABASE = ""metadata_index""
COLLECTION = ""data_assets""

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

# Filter for the specific SmartSPIM dataset
filter = {
    ""name"": ""SmartSPIM_675387_2023-05-23_23-05-56""
}

# Project only the session start and end times
projection = {
    ""acquisition.session_start_time"": 1,
    ""acquisition.session_end_time"": 1
}

# Retrieve the records
records = docdb_api_client.retrieve_docdb_records(
    filter_query=filter,
    projection=projection
)

# Calculate session duration
if records:
    session_start = datetime.fromisoformat(records[0]['acquisition']['session_start_time'])
    session_end = datetime.fromisoformat(records[0]['acquisition']['session_end_time'])

    session_duration = session_end - session_start

    print(f""Session Start Time: {session_start}"")
    print(f""Session End Time: {session_end}"")
    print(f""Total Session Duration: {session_duration}"")
else:
    print(""No records found for the specified SmartSPIM dataset."")"
What was the refractive index of the chamber immersion medium used in this experiment SmartSPIM_692908_2023-11-08_16-48-13_stitched_2023-11-09_11-12-06?,"The refractive index of the chamber immersion medium used in the experiment SmartSPIM_675387_2023-05-23_23-05-56 was 1.558, the medium was Ethyl cinnamate.",,"{""filter"":{""name"":""SmartSPIM_692908_2023-11-08_16-48-13_stitched_2023-11-09_11-12-06""},""projection"":{""acquisition.chamber_immersion.refractive_index"":1}}","import json
from aind_data_access_api.document_db import MetadataDbClient

API_GATEWAY_HOST = ""api.allenneuraldynamics.org""
DATABASE = ""metadata_index""
COLLECTION = ""data_assets""

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

# Filter to find the specific SmartSPIM experiment
filter = {
    ""name"": ""SmartSPIM_692908_2023-11-08_16-48-13_stitched_2023-11-09_11-12-06""
}

# Projection to retrieve chamber immersion details
projection = {
    ""acquisition.chamber_immersion"": 1
}

# Retrieve the records
records = docdb_api_client.retrieve_docdb_records(
    filter_query=filter,
    projection=projection
)

# Print the results
print(json.dumps(records, indent=2))"
"Can you list all the procedures performed on the specimen, including their start and end dates? in SmartSPIM_662616_2023-03-06_17-47-13","Subject procedures: 1. Surgery on 2023-01-25 with virus injections, 2. Surgery on 2023-01-25 with virus injection, Specimen procedures:1. Fixation (SHIELD OFF) from 2023-02-10 to 2023-02-122. Fixation (SHIELD ON) from 2023-02-12 to 2023-02-133. Delipidation (24h Delipidation) from 2023-02-15 to 2023-02-16  4. Delipidation (Active Delipidation) from 2023-02-16 to 2023-02-185. Refractive index matching (50% EasyIndex) from 2023-02-19 to 2023-02-206. Refractive index matching (100% EasyIndex) from 2023-02-20 to 2023-02-21, Imaging procedure: 1. SmartSPIM imaging session from 2023-03-06T17:47:13 to 2023-03-06T22:59:16",,"{""filter"":{""name"":""SmartSPIM_662616_2023-03-06_17-47-13""},""projection"":{""procedures.specimen_procedures"":1}}","import json
from aind_data_access_api.document_db import MetadataDbClient

API_GATEWAY_HOST = ""api.allenneuraldynamics.org""
DATABASE = ""metadata_index""
COLLECTION = ""data_assets""

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

# Filter for the specific SmartSPIM specimen
filter = {""name"": ""SmartSPIM_662616_2023-03-06_17-47-13""}

# Project only the specimen procedures
projection = {""procedures.specimen_procedures"": 1}

# Retrieve the records
records = docdb_api_client.retrieve_docdb_records(
    filter_query=filter,
    projection=projection
)

# Print the procedures in a readable format
print(""Procedures for SmartSPIM Specimen:"")
for record in records:
    procedures = record.get('procedures', {}).get('specimen_procedures', [])
    for procedure in procedures:
        print(f""\nProcedure Type: {procedure.get('procedure_type')}"")
        print(f""Procedure Name: {procedure.get('procedure_name')}"")
        print(f""Start Date: {procedure.get('start_date')}"")
        print(f""End Date: {procedure.get('end_date')}"")
        print(f""Experimenter: {procedure.get('experimenter_full_name')}"")"
For the thalamus in the middle project what were the genotypes used,,"Genotypes used:
[
  {
    ""genotype"": ""Slc32a1-IRES-Cre/wt""
  },
  {
    ""genotype"": ""wt/wt ""
  },
  {
    ""genotype"": ""Ai224(TICL-NLS-EGFP-ICF-NLS-dT)-hyg/wt""
  },
  {
    ""genotype"": ""RCL-H2B-GFP/wt""
  },
  {
    ""genotype"": ""VGAT-ChR2-YFP/wt""
  },
  {
    ""genotype"": null
  },
  {
    ""genotype"": ""wt/wt""
  }
]","{
""filter"":{
""data_description.project_name"":""Thalamus in the middle""
}
""projection"":{
""subject.genotype"":1
""name"":1
}
}","from aind_data_access_api.document_db import MetadataDbClient

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

agg_pipeline = [
    {
        ""$match"": {
            ""data_description.project_name"": {""$regex"": ""Thalamus in the middle"", ""$options"": ""i""}
        }
    },
    {
        ""$group"": {
            ""_id"": ""$subject.genotype"",
            ""count"": {""$sum"": 1}
        }
    }
]

result = docdb_api_client.aggregate_docdb_records(
    pipeline=agg_pipeline
)

print(""Genotypes in the Thalamus in the middle project:"")
for genotype in result:
    print(f""Genotype: {genotype['_id']}, Count: {genotype['count']}"")"
how many unique iacuc protocols are there?,Number of unique IACUC protocols: 22,,"{""agg_pipeline"":[{""$match"":{""procedures.subject_procedures"":{""$exists"":true,""$ne"":[]}}},{""$project"":{""iacuc_protocols"":""$procedures.subject_procedures.iacuc_protocol""}},{""$unwind"":""$iacuc_protocols""},{""$match"":{""iacuc_protocols"":{""$ne"":null}}},{""$group"":{""_id"":""$iacuc_protocols""}},{""$group"":{""_id"":null,""count"":{""$sum"":1}}}]}","
from aind_data_access_api.document_db import MetadataDbClient

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)



agg_pipeline = [
    {
        ""$project"": {
            ""iacuc_protocol"": ""$procedures.subject_procedures.iacuc_protocol""
        }
    },
    {
        ""$unwind"": {
            ""path"": ""$iacuc_protocol"", 
            ""preserveNullAndEmptyArrays"": False
        }
    },
    {
        ""$group"": {
            ""_id"": ""$iacuc_protocol""
        }
    },
    {
        ""$project"": {
            ""protocol"": ""$_id"", 
            ""_id"": 0
        }
    }
]

result = docdb_api_client.aggregate_docdb_records(
    pipeline=agg_pipeline
)

# Print the unique IACUC protocols
print(""Unique IACUC Protocols:"")
for protocol in result:
    print(protocol.get('protocol'))

# Count the number of unique protocols
unique_protocols = [p.get('protocol') for p in result if p.get('protocol') is not None]
print(f""\nTotal number of unique IACUC protocols: {len(unique_protocols)}"")"
I'm trying to understand an issue with misspelled project names. Could you help me write a query to get all project names and their counts? I don't need any other parts of the records for now.,"agg_pipeline = [{'$group': {'_id': '$project_name', 'count': {'$sum': 1}}},{'$sort': {'count': -1}}]",,"agg_pipeline = [{'$group': {'_id': '$project_name', 'count': {'$sum': 1}}},{'$sort': {'count': -1}}]","
from aind_data_access_api.document_db import MetadataDbClient

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)


# Aggregation pipeline to count project names
agg_pipeline = [
    {
        ""$match"": {
            ""data_description.project_name"": {""$exists"": True}
        }
    },
    {
        ""$group"": {
            ""_id"": ""$data_description.project_name"",
            ""count"": {""$sum"": 1}
        }
    },
    {
        ""$sort"": {""count"": -1}
    }
]

# Retrieve project name counts
result = docdb_api_client.aggregate_docdb_records(
    pipeline=agg_pipeline
)

# Print out project names and their counts
print(""Project Name Counts:"")
for project in result:
    project_name = project['_id'] if project['_id'] is not None else ""Unnamed Project""
    print(f""{project_name}: {project['count']} records"")

# Optional: Count of records with no project name
unnamed_count = next((project['count'] for project in result if project['_id'] is None), 0)
print(f""\nTotal records with no project name: {unnamed_count}"")"
Which assets have procedure dates that occurred before the subject's date of birth?,"[
  {
    ""_id"": ""a0ce0a8e-74bb-497e-ba13-9361c5b74dae"",
    ""name"": ""behavior_708032_2024-03-14_12-55-23"",
    ""subject_id"": ""708032"",
    ""date_of_birth"": ""2023-10-18"",
    ""procedure_date"": ""2023-01-08"",
    ""procedure_type"": ""Surgery""
  },
  {
    ""_id"": ""31dc4ada-3ef0-4ec7-95ac-6ecf2dde93eb"",
    ""name"": ""behavior_708032_2024-03-07_14-08-34"",
    ""subject_id"": ""708032"",
    ""date_of_birth"": ""2023-10-18"",
    ""procedure_date"": ""2023-01-08"",
    ""procedure_type"": ""Surgery""
  },
  {
    ""_id"": ""130a47ef-33df-43c5-b8e0-e01fe2c4c443"",
    ""name"": ""behavior_708032_2024-03-13_14-06-41"",
    ""subject_id"": ""708032"",
    ""date_of_birth"": ""2023-10-18"",
    ""procedure_date"": ""2023-01-08"",
    ""procedure_type"": ""Surgery""
  },
  {
    ""_id"": ""bdd1ece5-f178-4872-9af0-5505c1517a58"",
    ""name"": ""behavior_708032_2024-03-21_16-00-51"",
    ""subject_id"": ""708032"",
    ""date_of_birth"": ""2023-10-18"",
    ""procedure_date"": ""2023-01-08"",
    ""procedure_type"": ""Surgery""
  },
  {
    ""_id"": ""ecb51f81-6ff0-4fc8-958b-78ee4e2b25f1"",
    ""name"": ""behavior_708032_2024-03-11_13-48-50"",
    ""subject_id"": ""708032"",
    ""date_of_birth"": ""2023-10-18"",
    ""procedure_date"": ""2023-01-08"",
    ""procedure_type"": ""Surgery""
  },
  {
    ""_id"": ""420ae7e8-3c49-4a76-9d67-b7ebd0451c26"",
    ""name"": ""behavior_708032_2024-03-22_15-54-25"",
    ""subject_id"": ""708032"",
    ""date_of_birth"": ""2023-10-18"",
    ""procedure_date"": ""2023-01-08"",
    ""procedure_type"": ""Surgery""
  },
  {
    ""_id"": ""7dfcc710-445f-4551-ab70-b905b4ed67e9"",
    ""name"": ""behavior_708032_2024-03-18_14-23-51"",
    ""subject_id"": ""708032"",
    ""date_of_birth"": ""2023-10-18"",
    ""procedure_date"": ""2023-01-08"",
    ""procedure_type"": ""Surgery""
  },
  {
    ""_id"": ""48b21fdc-f578-4f2b-a91a-3a12f8be4cb8"",
    ""name"": ""behavior_708032_2024-03-06_17-39-03"",
    ""subject_id"": ""708032"",
    ""date_of_birth"": ""2023-10-18"",
    ""procedure_date"": ""2023-01-08"",
    ""procedure_type"": ""Surgery""
  },
  {
    ""_id"": ""dd5ba8b2-0287-4fe1-854f-a646ee259b28"",
    ""name"": ""behavior_708032_2024-03-05_17-25-28"",
    ""subject_id"": ""708032"",
    ""date_of_birth"": ""2023-10-18"",
    ""procedure_date"": ""2023-01-08"",
    ""procedure_type"": ""Surgery""
  },
  {
    ""_id"": ""ae10fc4e-38ee-4433-9144-4081bf3defa9"",
    ""name"": ""behavior_708032_2024-03-08_14-42-09"",
    ""subject_id"": ""708032"",
    ""date_of_birth"": ""2023-10-18"",
    ""procedure_date"": ""2023-01-08"",
    ""procedure_type"": ""Surgery""
  },
  {
    ""_id"": ""77d8c58b-319b-4662-b58b-d37f871f0d94"",
    ""name"": ""behavior_708032_2024-03-15_12-23-18"",
    ""subject_id"": ""708032"",
    ""date_of_birth"": ""2023-10-18"",
    ""procedure_date"": ""2023-01-08"",
    ""procedure_type"": ""Surgery""
  },
  {
    ""_id"": ""2cde4f27-78ef-4c85-ab72-e99e40357585"",
    ""name"": ""behavior_708032_2024-03-20_15-02-54"",
    ""subject_id"": ""708032"",
    ""date_of_birth"": ""2023-10-18"",
    ""procedure_date"": ""2023-01-08"",
    ""procedure_type"": ""Surgery""
  }
]

Total number of assets with procedures before birth date: 12",,"{""agg_pipeline"":[{""$match"":{""procedures"":{""$exists"":true},""subject.date_of_birth"":{""$exists"":true}}},{""$project"":{""_id"":1,""name"":1,""subject_id"":""$subject.subject_id"",""date_of_birth"":""$subject.date_of_birth"",""procedures"":""$procedures.subject_procedures""}},{""$unwind"":""$procedures""},{""$match"":{""$expr"":{""$lt"":[{""$dateFromString"":{""dateString"":""$procedures.start_date""}},{""$dateFromString"":{""dateString"":""$date_of_birth""}}]}}},{""$project"":{""_id"":1,""name"":1,""subject_id"":1,""date_of_birth"":1,""procedure_date"":""$procedures.start_date"",""procedure_type"":""$procedures.procedure_type""}},{""$limit"":100}]}","import json
from collections import Counter
from datetime import datetime

from aind_data_access_api.document_db import MetadataDbClient

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)


agg_pipeline = [
    # Ensure procedures and date of birth exist
    {
        ""$match"": {
            ""procedures"": {""$exists"": True}, 
            ""subject.date_of_birth"": {""$exists"": True}
        }
    },
    # Project and reshape the document
    {
        ""$project"": {
            ""_id"": 1,
            ""name"": 1,
            ""subject_id"": ""$subject.subject_id"", 
            ""date_of_birth"": ""$subject.date_of_birth"", 
            ""procedures"": ""$procedures.subject_procedures""
        }
    },
    # Unwind procedures to work with individual procedures
    {""$unwind"": ""$procedures""},

    # Ensure procedure start date exists and is not null
    {
        ""$match"": {
            ""procedures.start_date"": {""$exists"": True, ""$ne"": None}
        }
    },

    # Check if procedure date is before date of birth
    {
        ""$match"": {
            ""$expr"": {
                ""$lt"": [
                    {""$dateFromString"": {""dateString"": ""$procedures.start_date""}},
                    {""$dateFromString"": {""dateString"": ""$date_of_birth""}}
                ]
            }
        }
    },

    # Project final fields
    {
        ""$project"": {
            ""_id"": 1,
            ""name"": 1,
            ""subject_id"": 1,
            ""date_of_birth"": 1,
            ""procedure_date"": ""$procedures.start_date"",
            ""procedure_type"": ""$procedures.procedure_type""
        }
    },

    # Limit results
    {""$limit"": 20}
]

# Execute the aggregation
result = docdb_api_client.aggregate_docdb_records(
    pipeline=agg_pipeline
)

# Print results
print(json.dumps(result, indent=2))"
How many injections were done in total in the Ai224 animals?,The total number of injections performed on Ai224 animals was 155.,,"{""agg_pipeline"":[{""$match"":{""procedures.subject_procedures"":{""$exists"":true},""subject.genotype"":{""$regex"":""Ai224"",""$options"":""i""}}},{""$unwind"":""$procedures.subject_procedures""},{""$unwind"":""$procedures.subject_procedures.procedures""},{""$match"":{""procedures.subject_procedures.procedures.procedure_type"":{""$regex"":""injection"",""$options"":""i""}}},{""$count"":""total_injections""}]}","import json
from aind_data_access_api.document_db import MetadataDbClient

docdb_api_client = MetadataDbClient(
    host=API_GATEWAY_HOST,
    database=DATABASE,
    collection=COLLECTION,
)

agg_pipeline = [
    {
        ""$match"": {
            ""subject.genotype"": {""$regex"": ""Ai224"", ""$options"": ""i""}
        }
    },
    {
        ""$unwind"": {
            ""path"": ""$procedures.subject_procedures"", 
            ""preserveNullAndEmptyArrays"": False
        }
    },
    {
        ""$unwind"": {
            ""path"": ""$procedures.subject_procedures.procedures"", 
            ""preserveNullAndEmptyArrays"": False
        }
    },
    {
        ""$match"": {
            ""$or"": [
                {""procedures.subject_procedures.procedures.procedure_type"": {""$regex"": ""injection"", ""$options"": ""i""}},
                {""procedures.subject_procedures.procedures.procedure_type"": {""$regex"": ""nanoject"", ""$options"": ""i""}}
            ]
        }
    },
    {
        ""$count"": ""total_injections""
    }
]

result = docdb_api_client.aggregate_docdb_records(
    pipeline=agg_pipeline
)

print(""Total Injections for Ai224 animals:"")
print(json.dumps(result, indent=2))"
Give me a a concise summary of missing metadata fields in the 'Cognitive flexibility in patch foraging' project,"Based on the provided metadata records, the following fields are missing or incomplete across the project: Data Description: data_summary field is consistently null across all records group field is consistently null label field is consistently null Rig Information: Some records have complete rig information while others have rig: null Missing lens information for some camera setups (e.g., focal length for Bottom face Camera) Session Information: trials_finished, trials_rewarded, and trials_total are consistently null in stimulus epochs protocol_id is often empty or incomplete headframe_registration is consistently null Subject Information: background_strain is null breeding_info is null light_cycle information is missing in housing data home_cage_enrichment details are missing Quality Control: quality_control field is consistently null across all records These missing fields could be important for comprehensive analysis and reproducibility of the research conducted in this project.",,"{""agg_pipeline"":[{""$match"":{""data_description.project_name"":{""$regex"":""Cognitive flexibility in patch foraging"",""$options"":""i""}}},{""$project"":{""_id"":1,""name"":1,""subject_id"":""$subject.subject_id"",""project_name"":""$data_description.project_name"",""missing_subject_fields"":{""$objectToArray"":{""$ifNull"":[""$subject"",{}]}},""missing_data_description_fields"":{""$objectToArray"":{""$ifNull"":[""$data_description"",{}]}},""missing_procedures_fields"":{""$objectToArray"":{""$ifNull"":[""$procedures"",{}]}}}},{""$limit"":20}]}",
